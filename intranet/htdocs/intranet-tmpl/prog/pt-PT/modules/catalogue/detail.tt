[% USE raw %]
[% USE Asset %]
[% USE Koha %]
[% USE KohaDates %]
[% USE KohaPlugins %]
[% USE AuthorisedValues %]
[% USE Branches %]
[% USE Biblio %]
[% USE Frameworks %]
[% USE Price %]
[% USE TablesSettings %]
[% PROCESS 'i18n.inc' %]
[% SET CoverImagePlugins = KohaPlugins.get_plugins_intranet_cover_images %]

[% IF Koha.Preference('AmazonAssocTag') %]
 [% AmazonAssocTag = '?tag=' _ Koha.Preference('AmazonAssocTag') %]
[% ELSE %]
 [% AmazonAssocTag = '' %]
[% END %]

[% ShowCourseReserves = 0 | html %]
[% IF UseCourseReserves %]
 [% FOREACH item IN itemloop %]
 [% IF item.course_reserves %]
 [% FOREACH r IN item.course_reserves %]
 [% IF r.course.enabled == 'yes' %]
 [% ShowCourseReserves = 1 | html %]
 [% END %]
 [% END %]
 [% END %]
 [% END %]
[% END %]

[% SET plugins_intranet_catalog_biblio_tabs = KohaPlugins.get_plugins_intranet_catalog_biblio_tab({ biblio => biblio, biblio_id => biblionumber }) %]

[% SET footerjs = 1 %]
[% INCLUDE 'doc-head-open.inc' %]
<title>
 [% IF ( unknownbiblionumber ) %] Registo desconhecido [% ELSE %] Detalhes de [% INCLUDE 'biblio-title-head.inc' %] [% END %] &rsaquo; Catálogo &rsaquo; Koha </title>
[% INCLUDE 'doc-head-close.inc' %]
[% Asset.css("lib/Chocolat/css/chocolat.css") | $raw %]
</head>

<body id="catalog_detail" class="catalog">

[% WRAPPER 'header.inc' %]
 [% INCLUDE 'cat-search.inc' %]
[% END %]

[% WRAPPER 'sub-header.inc' %]
 [% WRAPPER breadcrumbs %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/catalogue/search.pl">Catálogo</a>
 [% END %]

 [% IF ( unknownbiblionumber ) %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 <span>Registo desconhecido</span>
 [% END %]
 [% ELSE %]
 [% WRAPPER breadcrumb_item %]
 [% INCLUDE 'biblio-title.inc' link = 1 %]
 [% END %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 <span>Detalhes</span>
 [% END %]
 [% END %]
 [% END #/ WRAPPER breadcrumbs %]
[% END #/ WRAPPER sub-header.inc %]

<div class="main container-fluid">
 <div class="row">
 <div class="col-sm-10 col-sm-push-2">
 <main>
 <div class="row">

[% IF ( unknownbiblionumber ) %]
 <div class="dialog message">O registo pedido não existe ([% biblionumber | html %]).</div>
[% ELSE %]

[% IntranetCoce    = Koha.Preference('IntranetCoce') %]
[% CoceProviders   = Koha.Preference('CoceProviders') %]
[% CoceHost        = Koha.Preference('CoceHost') %]
[% SyndeticsCovers = Koha.Preference('SyndeticsEnabled') && Koha.Preference('SyndeticsCoverImages') %]

[% INCLUDE 'cat-toolbar.inc' %]
 [% IF decoding_error %]
 <div>
 <span class="biberror">
 Existe um erro neste registo bibliográfico, a visualização pode estar degradada.</span>
 <span class="error"><br/> Erro: [% decoding_error | html %]</span>
 </div>
 [% END %]
 [% IF analytics_error %]
 <div>
 <span class="analytics_error">
 Ocorreu um erro ao pesquisar pelos registos analíticos, por favor verificar os registos do sistema para mais detalhes.</span>
 </div>
 [% END %]
 [% IF ( ocoins ) %]
 <!-- COinS / OpenURL -->
 <span class="Z3988" title="[% ocoins | html %]"></span>
 [% END %]

 [% IF ( CoverImagePlugins || AmazonCoverImages  || LocalCoverImages || IntranetCoce || ( SyndeticsCovers ) || (Koha.Preference('CustomCoverImages') && Koha.Preference('CustomCoverImagesURL')) ) %]
 <div id="catalogue_detail_biblio" class="col-xs-9">
 [% ELSE %]
 <div id="catalogue_detail_biblio" class="col-xs-12">
 [% END %]
 <div class="page-section">

 [% XSLTBloc | $raw %]

 [% IF shelves.count %]
 <span class="results_summary"><span class="label">Listas que incluem este título: </span>
 [% FOREACH s IN shelves %]
 <a href="/cgi-bin/koha/virtualshelves/shelves.pl?op=view&amp;shelfnumber=[% s.shelfnumber | uri %]">[% s.shelfname | html %]</a>
 [% IF ( loop.last ) %][% ELSE %]|[% END %]
 [% END %]
 </span>
 [% END %]
 [% IF ( TagsEnabled &&  TagsShowOnDetail &&  TagLoop ) %]
 <span class="results_summary"><span class="label">Etiquetas:</span>
 [% FOREACH TagLoo IN TagLoop %]
 [% IF ( CAN_user_tools_moderate_tags ) %]
 <a href="/cgi-bin/koha/tags/list.pl?tag=[% TagLoo.term |uri %]">[% TagLoo.term | html %]</a>
 [% ELSE %]
 [% TagLoo.term | html %]
 [% END %]
 <span class="weight">([% TagLoo.weight_total | html %])</span>[% IF ( loop.last ) %][% ELSE %], [% END %]
 [% END %]
 </span>
 [% END %]
 <span id="catalogue_detail_marc_preview" class="results_summary"><span class="label">Pré-visualização MARC:</span> <a href="/cgi-bin/koha/catalogue/showmarc.pl?id=[% biblionumber | uri %]&amp;viewas=html" title="MARC" class="previewMARC">Ver</a></span>
 <span id="catalogue_detail_framework" class="results_summary">
 <span class="label">Modelo MARC:</span>
 <span class="frameworkcode">[% Frameworks.GetName(biblio.frameworkcode) | html %]</span>
 </span>
 [% IF !item_level_itypes ||  Koha.Preference("BiblioItemtypeInfo") %]
 <span class="results_summary itemtype"><span class="label">Tipo de documento:</span>
 [% IF ( !noItemTypeImages && imageurl ) %]
 <img src="[% imageurl | html %]" alt="" />
 [% END %]
 [% IF ( description ) %]
 <span class="itypetext">[% description | html %]</span>
 [% ELSE %]
 <span class="itypetext">[% itemtype | html %]</span>
 [% END %]
 </span>
 [% END %]

 [% IF ( Koha.Preference('SearchEngine') == 'Elasticsearch' ) %]
 <span id="catalogue_detail_elastic_record" class="results_summary"><span class="label">Registo no Elasticsearch:</span> <a class="previewElastic" href="/cgi-bin/koha/catalogue/showelastic.pl?id=[% biblionumber | uri %]" title="Registo no Elasticsearch">Ver</a></span>
 [% END %]

 [% IF ( holdcount ) %]
 <span class="results_summary">
 <span class="label">Reservas:</span>
 <span class="number_box">
 [% IF CAN_user_reserveforothers_place_holds %]
 <a href="/cgi-bin/koha/reserve/request.pl?biblionumber=[% biblionumber | uri %]">[% holdcount | html %]</a>
 [% ELSE %]
 <span>[% holdcount | html %]</span>
 [% END %]
 </span>
 </span>
 [% END %]

 [% IF illrequests.count %]
 <span class="results_summary">
 <span class="label">Pedidos de empréstimo inter-bibliotecas:</span>
 [% IF CAN_user_ill %]
 [% FOREACH ill IN illrequests %]
 <a href="/cgi-bin/koha/ill/ill-requests.pl?method=illview&illrequest_id=[% ill.illrequest_id | uri %]">Pedido [% ill.illrequest_id | html %]</a>[% IF ! loop.last %], [% END %]
 [% END %]
 [% ELSE %]
 [% FOREACH ill IN illrequests %]
 <span>Pedido [% ill.illrequest_id | html %]</span>[% IF ! loop.last %], [% END %]
 [% END %]
 [% END %]
 </span>
 [% END %]

 [% IF ( article_requests_count = Biblio.ArticleRequestsActiveCount( biblionumber ) ) %]
 <span class="results_summary">
 <span class="label">Pedidos de artigo:</span>
 <span class="number_box">
 <a href="/cgi-bin/koha/circ/request-article.pl?biblionumber=[% biblionumber | uri %]">[% article_requests_count | html %]</a>
 </span>
 </span>
 [% END %]

 [% IF course_reserves %]
 <span class="results_summary"><span class="label">Cursos que incluem este título: </span>
 [% FOREACH c IN course_reserves %]
 <a href="/cgi-bin/koha/course_reserves/course-details.pl?course_id=[% c.course_id | uri %]">[% c.course.course_name | html %]</a>
 [% IF ( loop.last ) %][% ELSE %]|[% END %]
 [% END %]
 </span>
 [% END %]
 </div> [%# .page-section %]

 [% IF ( CoverImagePlugins || AmazonCoverImages  || LocalCoverImages || IntranetCoce || ( SyndeticsCovers ) || (Koha.Preference('CustomCoverImages') && Koha.Preference('CustomCoverImagesURL')) ) %]
 </div>
 <div class="col-xs-3 bookcoverimg">
 <div id="biblio-cover-slider" class="cover-slider" data-isbn="[% normalized_isbn | html %]">
 [% IF ( LocalCoverImages ) %]
 [% IF localimages.count %]
 [% FOREACH image IN localimages %]
 <div class="cover-image local-coverimg">
 <a href="/cgi-bin/koha/catalogue/image.pl?imagenumber=[% image.imagenumber | uri %]" title="Imagem de capa local">
 <img alt="Imagem de capa local" data-link="/cgi-bin/koha/catalogue/imageviewer.pl?biblionumber=[% biblionumber | uri %]&imagenumber=[% image.imagenumber | uri %]" src="/cgi-bin/koha/catalogue/image.pl?thumbnail=1&imagenumber=[% image.imagenumber | uri %]" />
 </a>
 <div class="hint">Imagem de capa local</div>
 </div>
 [% END %]
 [% END %]
 [% END %]

 [% IF ( AmazonCoverImages && normalized_isbn) %]
 <div class="cover-image" id="amazon-bookcoverimg">
 <a href="https://images-na.ssl-images-amazon.com/images/P/[% normalized_isbn | uri %].01.LZZZZZZZ.jpg" title="Imagem de capa da Amazon">
 <img alt="Imagem de capa da Amazon" data-link="http://www.amazon[% AmazonTld | uri %]/gp/reader/[% normalized_isbn | uri %][% AmazonAssocTag | uri %]#reader-link" src="https://images-na.ssl-images-amazon.com/images/P/[% normalized_isbn | uri %].01.MZZZZZZZ.jpg" />
 </a>
 <div class="hint">Imagem da Amazon.com</div>
 </div>
 [% END %]

 [% IF ( IntranetCoce && CoceProviders && normalized_isbn ) %]
 [% coce_id = normalized_ean || normalized_isbn %]
 <div class="cover-image coce-coverimg">
 [% IF ( coce_id ) %]
 <a class="[% coce_id | html %]" id="coce-thumbnail-preview" title="Imagem da Coce"></a>
 [% ELSE %]
 <span class="no-image">Sem imagem de capa disponível</span>
 [% END %]
 <div class="hint">Imagem da Coce</div>
 </div>
 [% END %]

 [% IF ( SyndeticsCovers ) %]
 [% IF ( content_identifier_exists ) %]
 <div class="cover-image" id="syndetics-bookcoverimg">
 <a href="https://secure.syndetics.com/index.aspx?isbn=[% normalized_isbn | url %]/LC.GIF&client=[% Koha.Preference('SyndeticsClientCode') | url %]&type=xw10&upc=[% normalized_upc | url %]&oclc=[% normalized_oclc | url %]" title="Imagem de capa da Syndetics">
 <img src="https://secure.syndetics.com/index.aspx?isbn=[% normalized_isbn | url %]/[% Koha.Preference('SyndeticsCoverImageSize') | url %].GIF&amp;client=[% Koha.Preference('SyndeticsClientCode') | url %]&amp;type=xw10&amp;upc=[% normalized_upc | url %]&amp;oclc=[% normalized_oclc | url %]" alt="" class="thumbnail" />
 </a>
 <div class="hint">Imagem da Syndetics</div>
 </div>
 [% ELSE %]
 <span class="no-image">Sem imagem de capa disponível</span>
 [% END %]
 [% END %]

 [% IF Koha.Preference('CustomCoverImages') && Koha.Preference('CustomCoverImagesURL') %]
 [% SET custom_cover_image_url = biblio.custom_cover_image_url %]
 [% IF custom_cover_image_url %]
 <div class="cover-image" id="custom-coverimg">
 <a class="custom_cover_image" href="[% custom_cover_image_url | url %]" title="Imagem de capa personalizada">
 <img alt="Imagem de capa personalizada" id="custom-img" src="[% custom_cover_image_url | url %]" />
 </a>
 <div class="hint">Imagem de capa personalizada</div>
 </div>
 [% END %]
 [% END %]
 </div> <!-- /.cover-slider -->
 </div> <!-- /.bookcoverimg.col-xs-3 -->
 [% ELSE %]
 </div> <!-- /.col-xs-* -->
 [% END # /IF ( AmazonCoverImages, etc ) %]
</div>

<div id="bibliodetails" class="toptabs">

<ul class="nav nav-tabs" role="tablist">
 [% IF (SeparateHoldings) %]
 <li role="presentation">
 <a href="#holdings" aria-controls="holdings" role="tab" data-toggle="tab">[% Branches.GetLoggedInBranchname | html %] exemplares ([% itemloop.size() || 0 | html %])</a>
 </li>
 <li role="presentation">
 <a href="#otherholdings"  aria-controls="otherholdings" role="tab" data-toggle="tab">Outros exemplares ([% otheritemloop.size() || 0 | html %])</a>
 </li>
 [% ELSE %]
 <li role="presentation">
 <a href="#holdings" aria-controls="holdings" role="tab" data-toggle="tab">Exemplares ([% itemloop.size() || 0 | html %])</a>
 </li>
 [% END %]
 [% IF Koha.Preference('EnableItemGroups') %]
 <li role="presentation">
 <a href="#item_groups" aria-controls="item_groups" role="tab" data-toggle="tab">Grupos de exemplares</a>
 </li>
 [% END %]
[% IF ( MARCNOTES || notes ) %]<li role="presentation"><a href="#description" aria-controls="description" role="tab" data-toggle="tab">Descrições ([% ( MARCNOTES.size || 1 ) | html %])</a></li>[% END %]
[% IF ComponentParts && ComponentParts.size %]<li id="components_tab" role="presentation"><a href="#components"  aria-controls="components" role="tab" data-toggle="tab">Componentes ([% ComponentParts.size | html %])</a></li>[% END %]
[% IF ( subscriptionsnumber ) %]<li role="presentation"><a href="#subscriptions"  aria-controls="subscriptions" role="tab" data-toggle="tab">Assinaturas</a></li>[% END %]
[% IF Koha.Preference('AcquisitionDetails') %]<li role="presentation"><a href="#acq_details"  aria-controls="acq_details" role="tab" data-toggle="tab">Detalhes de aquisição</a></li>[% END %]
[% IF suggestions.count %]<li role="presentation"><a href="#suggestion_details"  aria-controls="suggestion_details" role="tab" data-toggle="tab">Detalhes da sugestão</a></li>[% END %]
[% IF ( FRBRizeEditions ) %][% IF ( XISBNS ) %]<li role="presentation"><a href="#editions"  aria-controls="editions" role="tab" data-toggle="tab">Edição</a></li>[% END %][% END %]
[% IF ( ( Koha.Preference('CatalogConcerns') || Koha.Preference('OpacCatalogConcerns') ) && CAN_user_editcatalogue_edit_catalogue ) %]<li role="presentation"><a href="#concerns" aria-controls="concerns" role="tab" data-toggle="tab">Problemas ([% biblio.tickets.count | html %])</a></li>[% END %]
[% IF ( LocalCoverImages ) %]
 <li role="presentation">
 <a href="#images"  aria-controls="images" role="tab" data-toggle="tab">Imagens ([% localimages.count || 0 | html %])</a>
 </li>
[% END %]
[% IF HTML5MediaEnabled && HTML5MediaSets.size %]
 <li id="media_tab" role="presentation"><a href="#html5media"  aria-controls="html5media" role="tab" data-toggle="tab">Reproduzir</a></li>
[% END %]
[% IF ( Koha.Preference('NovelistSelectStaffEnabled') && Koha.Preference('NovelistSelectStaffProfile') && Koha.Preference('NovelistSelectStaffView') == 'tab' ) %]
 <li class="NovelistSelect" style="display:none;" role="presentation"><a href="#NovelistSelect"  aria-controls="NovelistSelect" role="tab" data-toggle="tab">NoveList Select</a></li>
[% END %]
[% FOREACH plugins_intranet_catalog_biblio_tab IN plugins_intranet_catalog_biblio_tabs %]
 <li role="presentation"><a href="#[% plugins_intranet_catalog_biblio_tab.id | uri %]"  aria-controls="[% plugins_intranet_catalog_biblio_tab.id | uri %]" role="tab" data-toggle="tab">[% plugins_intranet_catalog_biblio_tab.title | html %]</a></li>
[% END %]
</ul>

<div class="tab-content">
[% items_table_block_iter = 0 %]
[% BLOCK items_table %]
 [% items_table_block_iter = items_table_block_iter + 1 %]
 <div class="[% tab | html %]_table_table_controls">
 [% IF (StaffDetailItemSelection) %]
 | <a href="#" class="SelectAll" data-tab="[% tab | html %]"><i class="fa fa-check"></i> Seleccionar todos</a> |
 <a href="#" class="ClearAll" data-tab="[% tab | html %]"><i class="fa fa-remove"></i> Limpar todos</a>
 <span class="itemselection_actions">
 | Ações: [% IF CAN_user_tools_items_batchdel %] <a class="itemselection_action_delete"><i class="fa fa-trash"></i> Eliminar exemplares seleccionados</a>
 [% END %]
 [% IF CAN_user_tools_items_batchmod %]
 <a class="itemselection_action_modify"><i class="fa fa-pencil"></i> Modificar exemplares selecionados</a>
 [% END %]
 [% IF CAN_user_editcatalogue_manage_item_groups && biblio.item_groups.count %]
 <a class="itemselection_action_item_group_set" href="#"><i class="fa fa-book"></i> Adicionar/mover para o grupo de exemplares</a>
 <a class="itemselection_action_item_group_unset" href="#"><i class="fa fa-unlink"></i> Remover do grupo de exemplares</a>
 [% END %]
 </span>
 [% END %]
 </div>
 <table class="items_table" id="[% tab | html %]_table">
 <thead>
 <tr>
 [% IF (StaffDetailItemSelection) %]<th id="[% tab | html %]_checkbox" data-colname="[% tab | html %]_checkbox" class="NoSort"></th>[% END %]
 [% IF Koha.Preference('LocalCoverImages') && ( tab == 'holdings' && itemloop_has_images || tab == 'otherholdings' && otheritemloop_has_images ) %]
 <th id="[% tab | html %]_cover_image" data-colname="[% tab | html %]_cover_image">Imagem da capa</th>
 [% END %]
 [% IF ( item_level_itypes ) %]<th id="[% tab | html %]_itype" data-colname="[% tab | html %]_itype">Tipo de documento</th>[% END %]
 <th id="[% tab | html %]_holdingbranch" data-colname="[% tab | html %]_holdingbranch">Biblioteca</th>
 <th id="[% tab | html %]_homebranch" data-colname="[% tab | html %]_homebranch">Biblioteca de inscrição</th>
 [% IF ( itemdata_ccode ) %]<th id="[% tab | html %]_ccode" data-colname="[% tab | html %]_ccode">Coleção</th>[% END %]
 [% IF Koha.Preference('EnableItemGroups') %]
 <th id="[% tab | html %]_item_group" data-colname="[% tab | html %]_item_group">Grupo de exemplares</th>
 [% END %]
 <th id="[% tab | html %]_itemcallnumber" data-colname="[% tab | html %]_itemcallnumber">Cota</th>
 [% IF volinfo %]
 <th id="[% tab | html %]_enumchron" data-colname="[% tab | html %]_enumchron">Enumeração / cronologia</th>
 [% END %]
 <th id="[% tab | html %]_status" data-colname="[% tab | html %]_status">Estado</th>
 <th id="[% tab | html %]_lastseen" data-colname="[% tab | html %]_lastseen">Último acesso</th>
 <th id="[% tab | html %]_issues" data-colname="[% tab | html %]_issues">Empréstimo(s)</th>
 <th id="[% tab | html %]_renewals" data-colname="[% tab | html %]_renewals">Renovações</th>
 <th id="[% tab | html %]_dateaccessioned" data-colname="[% tab | html %]_dateaccessioned">Data de acesso</th>
 <th id="[% tab | html %]_datelastborrowed" data-colname="[% tab | html %]_datelastborrowed">Data de último empréstimo</th>
 <th id="[% tab | html %]_barcode" data-colname="[% tab | html %]_barcode">Código de barras</th>
 [% IF ( itemdata_uri ) %]<th id="[% tab | html %]_uri" data-colname="[% tab | html %]_uri">URL</th>[% END %]
 [% IF ( itemdata_copynumber ) %]<th id="[% tab | html %]_copynumber" data-colname="[% tab | html %]_copynumber">Número de cópia</th>[% END %]
 [% IF ( itemdata_stocknumber ) %]<th id="[% tab | html %]_stocknumber" data-colname="[% tab | html %]_stocknumber">Número de inventário</th>[% END %]
 [% IF materials %]<th id="[% tab | html %]_materials" data-colname="[% tab | html %]_materials">Materiais especificados</th>[% END %]
 [% IF ( itemdata_itemnotes ) %]<th id="[% tab | html %]_itemnotes" data-colname="[% tab | html %]_itemnotes">Notas públicas</th>[% END %]
 [% IF ( itemdata_nonpublicnotes ) %]<th id="[% tab | html %]_itemnotes_nonpublic" data-colname="[% tab | html %]_itemnotes_nonpublic">Notas internas</th>[% END %]
 [% IF ( hostrecords ) %]<th id="[% tab | html %]_hostrecord" data-colname="[% tab | html %]_hostrecord">Registos fonte</th>[% END %]
 [% IF ( analyze ) %]<th id="[% tab | html %]_usedin" data-colname="[% tab | html %]_usedin">Utilizado em</th><th></th>[% END %]
 [% IF ( ShowCourseReserves ) %]<th id="[% tab | html %]_course_reserves" data-colname="[% tab | html %]_course_reserves">Reservas de curso</th>[% END %]
 [% IF ( SpineLabelShowPrintOnBibDetails ) %]<th id="[% tab | html %]_spinelabel" data-colname="[% tab | html %]_spinelabel" class="NoSort">Etiqueta</th>[% END %]
 [% IF ( CAN_user_editcatalogue_edit_items ) %]<th id="[% tab | html %]_actions" data-colname="[% tab | html %]_actions"class="NoSort noExport">&nbsp;</th>[% END %]
 </tr>
 </thead>
 <tbody>
 [% FOREACH item IN items %]
 [% SET date_due = item.object.checkout.date_due %]
 <tr id="item_[% item.itemnumber | html %]" data-itemnumber="[% item.itemnumber | html %]" data-duedate="[% date_due | html %]">
 [% IF (StaffDetailItemSelection) %]
 <td style="text-align:center;vertical-align:middle">
 [% IF item.can_be_edited %]
 <input type="checkbox" value="[% item.itemnumber | html %]" name="itemnumber" />
 [% END %]
 </td>
 [% END %]
 [% IF Koha.Preference('LocalCoverImages') && ( tab == 'holdings' && itemloop_has_images || tab == 'otherholdings' && otheritemloop_has_images ) %]
 <td class="cover">
 <div class="bookcoverimg">
 <div class="cover-slider">
 [% FOREACH image IN item.object.cover_images %]
 <div class="cover-image local-coverimg">
 <a href="/cgi-bin/koha/catalogue/image.pl?itemnumber=[% image.itemnumber | uri %]&imagenumber=[% image.imagenumber | uri %]" title="Imagem de capa local">
 <img alt="Imagem de capa local" data-link="/cgi-bin/koha/catalogue/imageviewer.pl?itemnumber=[% item.itemnumber | uri %]&imagenumber=[% image.imagenumber | uri %]" src="/cgi-bin/koha/catalogue/image.pl?thumbnail=1&imagenumber=[% image.imagenumber | uri %]" />
 </a>
 </div>
 [% END %]
 </div>
 </div>
 </td>
 [% END %]

 [% IF ( item_level_itypes ) %]
 <td class="itype">
 [% SET itemtype = item.itemtype %]
 [% IF !noItemTypeImages && itemtype.image_location('intranet') %]
 <img src="[% itemtype.image_location('intranet') | html %]" alt="[% itemtype.translated_description | html %]" title="[% itemtype.translated_description | html %]" />
 [% END %]
 <span class="itypedesc itypetext">[% itemtype.translated_description | html %]</span>
 </td>
 [% END %]
 <td class="location">[% UNLESS ( singlebranchmode ) %][% Branches.GetName( item.holdingbranch ) | html %] [% END %]</td>
 <td class="homebranch">
 <span class="homebranchdesc">[% Branches.GetName(item.homebranch) | html %]</span>
 <span class="shelvingloc">
 [%# If permanent location is defined, show description or code and             %]
 [%# display current location in parentheses. If not, display current location. %]
 [%# Note that permanent location is a code, and location may be an authval.    %]
 [% SET item_location = AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.location', authorised_value => item.location ) %]
 [% IF item.permanent_location %]
 [% SET permloc_authval = AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.location', authorised_value => item.permanent_location ) %]
 [% permloc_authval | html %]
 [% IF item_location AND item_location != permloc_authval AND item.location != item.permanent_location %]
 ([% item_location | html %])
 [% END %]
 [% ELSE %]
 [% item_location | html %]
 [% END %]
 </span>
 </td>
 [% IF ( itemdata_ccode ) %]<td>[% AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.ccode', authorised_value => item.ccode ) | html %]</td>[% END %]
 [% IF Koha.Preference('EnableItemGroups') %]<td class="item_group">[% item.object.item_group.description | html %]</td>[% END %]
 <td class="itemcallnumber">[% IF ( item.itemcallnumber ) %] [% item.itemcallnumber | html %][% END %]</td>
 [% IF ( volinfo ) %]
 [% SET serial = item.serial %]
 [% IF itemdata_publisheddate #If there is at least one published date, use it for sorting %]
 <td class="enumchron" data-order="[% serial.publisheddate | html %]">
 [% ELSE %]
 <td class="enumchron">
 [% END %]
 [% IF ( itemdata_enumchron ) %]
 [% IF item.enumchron && serial.serialseq %]
 <span class="enum">[% item.enumchron | html %]</span>
 [% IF ( serial.serialseq && item.enumchron != serial.serialseq ) %]
 <span class="sep"> -- </span>
 <span class="serialseq">[% serial.serialseq | html %]</span>
 [% END %]
 [% ELSIF item.enumchron %]
 <span class="enum">[% item.enumchron | html %]</span>
 [% ELSIF item.serialseq %]
 <span class="serialseq">[% serial.serialseq | html %]</span>
 [% END %]
 [% IF serial.publisheddate %]
 <span class="pubdate">([% serial.publisheddate | $KohaDates %])</span>
 [% END %]
 [% END %]
 </span>
 </td>
 [% END %]
 <td class="status">

 [% IF item.object.checkout %]
 [% IF item.object.checkout.onsite_checkout %]
 <span>Atualmente em uso local [% ELSE %] <span class="datedue">Emprestado [% END %] [% IF item.can_be_edited %] [% IF item.object.checkout.onsite_checkout %] por [% ELSE %] a [% END %] [% INCLUDE 'patron-title.inc' patron=item.object.checkout.patron hide_patron_infos_if_needed=1 %] [% END %] : termina a [% date_due | $KohaDates as_due_date => 1 %] </span>
 [% ELSIF ( transfer = item.object.get_transfer ) %]
 [% IF (transfer.datesent) %]
 <span class="intransit">Em trânsito de [% Branches.GetName( transfer.frombranch ) | html %] para [% Branches.GetName( transfer.tobranch ) | html %] desde [% transfer.datesent | $KohaDates %]</span>
 [% ELSE %]
 <span class="transitrequested">Transferência pendente de [% Branches.GetName( transfer.frombranch ) | html %] para [% Branches.GetName( transfer.tobranch ) | html %] desde [% item.transfer.daterequested | $KohaDates %]</span>

 [% END %]
 [% END %]

 [% IF ( item.itemlost ) %]
 [% SET itemlost_description = AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.itemlost', authorised_value => item.itemlost ) %]
 [% IF itemlostloop %]
 <span class="lost">[% itemlost_description | html %]</span>
 [% ELSE %]
 <span class="lost">Indisponível (extraviado ou em falta)</span>
 [% END %]
 [% END %]

 [% IF ( item.withdrawn ) %]
 [% SET withdrawn_description = AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.withdrawn', authorised_value => item.withdrawn ) %]
 [% IF withdrawn_description %]
 <span class="wdn">[% withdrawn_description | html %]</span>
 [% ELSE %]
 <span class="wdn">Retirado</span>
 [% END %]
 [% END %]

 [% IF ( item.damaged ) %]
 [% SET damaged_description = AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.damaged', authorised_value => item.damaged ) %]
 [% IF damaged_description %]
 <span class="dmg">[% damaged_description | html %]</span>
 [% ELSE %]
 <span class="dmg">Danificado</span>
 [% END %]
 [% END %]

 [% IF ( item.notforloan || item.itemtype.notforloan ) %]
 <span class="notforloan">Não emprestável [% SET not_for_loan_description = AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.notforloan', authorised_value => item.notforloan ) %] [% IF not_for_loan_description %] <span class="reason">([% not_for_loan_description | html %])</span>
 [% END %]
 </span>
 [% END %]

 [% SET hold = item.first_hold %]
 [% IF hold %]
 [% IF hold.waitingdate %]
 <span class="waitingat">Em espera em [% Branches.GetName( hold.branchcode ) | html %][% IF ( hold.desk_id ) %], [% hold.desk.desk_name | html %][% END %] desde [% hold.waitingdate | $KohaDates %].</span>
 [% IF canreservefromotherbranches AND ( hold.waitingdate OR hold.priority == 1 ) %]
 <span class="heldfor">Reserva para:</span>
 [% INCLUDE 'patron-title.inc' patron=hold.borrower hide_patron_infos_if_needed=1 %]
 [% END %]
 [% ELSE %]
 <span class="holdonitem">Existe uma reserva ao nível do exemplar para este exemplar (prioridade = [% hold.priority | html %]).</span>
 [% END %]
 [% END %]

 [% IF Koha.Preference('UseRecalls') %]
 [% SET recall = item.object.recall %]
 [% IF recall %]
 [% IF recall.waiting_date %]
 <span>Em espera em [% Branches.GetName( recall.pickup_library_id ) | html %] desde [% recall.waiting_date | $KohaDates %]</span>
 [% ELSE %]
 [% patron_link = BLOCK %]<a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% recall.patron_id | uri %]">[% recall.patron.firstname | html %] [% recall.patron.surname | html %] ([% recall.patron.cardnumber | html %])</a>[% END %]
 <span>reclamado por [% patron_link| $raw %] em [% recall.created_date | $KohaDates %]</span>
 [% END %]
 [% END %]
 [% END %]

 [% UNLESS ( item.notforloan || item.itemtype.notforloan || item.onloan || item.itemlost || item.withdrawn || item.damaged || item.transfer || hold || ( Koha.Preference('UseRecalls') && recall ) ) %]
 <span>Disponível</span>
 [% END %]

 [% IF ( item.restricted ) %]
 <span class="restricted">([% AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.restricted', authorised_value => item.restricted ) | html %])</span>
 [% END %]

 [% IF ( item.bundle_host ) %]
 <span class="bundled">No conjunto: [% INCLUDE 'biblio-title.inc' biblio = item.bundle_host.biblio link = 1 %]</span>
 [% END %]

 </td>
 <td class="datelastseen" data-order="[% item.datelastseen | html %]">[% item.datelastseen | $KohaDates with_hours => 1 %]</td>
 <td class="issues" data-order="[% item.issues || 0 | html %]">[% item.issues || 0 | html %]</td>
 <td class="renewals" data-order="[% item.renewals || 0 | html %]">[% item.renewals || 0 | html %]</td>
 <td class="dateaccessioned" data-order="[% item.dateaccessioned | html %]">[% item.dateaccessioned | $KohaDates %]</td>
 <td class="datelastborrowed" data-order="[% item.datelastborrowed | html %]">[% item.datelastborrowed | $KohaDates %]</td>
 <td><a href="/cgi-bin/koha/catalogue/moredetail.pl?itemnumber=[% item.itemnumber | uri %]&amp;biblionumber=[% item.biblionumber | uri %]&amp;bi=[% item.biblioitemnumber | uri %]#item[% item.itemnumber | uri %]">[% item.barcode | html %]</a></td>
 [% IF ( itemdata_uri ) %]
 [% IF item.uri.split(' \| ').size > 1 %]
 <td class="uri">
 [% FOREACH uri IN item.uri.split(' \| ') %]<a href="[% uri | url %]">[% uri | html %]</a><br>[% END %]
 </td>
 [% ELSE %]
 <td class="uri">
 [% IF item.uri %]
 <a href="[% item.uri | url %]">[% IF Koha.Preference('URLLinkText') %][% Koha.Preference('URLLinkText') | html %][% ELSE %]Ligação para o recurso[% END %]</a>
 [% END %]
 </td>
 [% END %]
 [% END %]
 [% IF ( itemdata_copynumber ) %]
 <td class="copynumber">[% AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.copynumber', authorised_value => item.copynumber ) | html %]</td>
 [% END %]
 [% IF ( itemdata_stocknumber ) %]
 <td class="stocknumber">[% item.stocknumber | html %]</td>
 [% END %]
 [% IF materials %]
 <td class="materials"> [% item.materials | html %] </td>
 [% END %]
 [% IF ( itemdata_itemnotes ) %]
 <td><div class="itemnotes">[% item.object.itemnotes.replace('\n','<br />') | $raw %]</div></td>
 [% END %]
 [% IF itemdata_nonpublicnotes %]
 <td class="nonpublicnote">[% item.itemnotes_nonpublic | html %]</td>
 [% END %]
 [% IF ( hostrecords ) %]
 <td>[% IF ( item.hostbiblionumber) %]<a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=[% item.hostbiblionumber | uri %]" >[% item.hosttitle | html %]</a>[% END %]</td>
 [% END %]
 [% IF ( analyze ) %]
 <td>
 [% IF ( item.countanalytics ) %]
 <a href="/cgi-bin/koha/catalogue/search.pl?idx=hi&amp;q=[% item.itemnumber | uri %]">[% item.countanalytics | html %] analíticos</a>
 [% END %]
 </td>
 [% END %]
 [% IF ( analyze ) %]
 <td><a href="/cgi-bin/koha/cataloguing/addbiblio.pl?hostbiblionumber=[% item.biblionumber | uri %]&amp;hostitemnumber=[% item.itemnumber | uri %]">Criar analíticos</a></td>
 [% END %]

 [% IF ShowCourseReserves %]
 <td>
 [% IF item.course_reserves %]
 [% FOREACH r IN item.course_reserves %]
 [% IF r.course.enabled == 'yes' %]
 <p>
 <a href="/cgi-bin/koha/course_reserves/course-details.pl?course_id=[% r.course.course_id | uri %]">
 [% r.course.course_name | html %]
 <!--[% IF r.course.course_number %] [% r.course.course_number | html %] [% END %]-->
 [% IF r.course.section %] [% r.course.section | html %] [% END %]
 [% IF r.course.term %] [% AuthorisedValues.GetByCode( 'TERM', r.course.term ) | html %] [% END %]
 </a>
 </p>
 [% END %]
 [% END %]
 [% END %]
 </td>
 [% END %]

 [% IF ( SpineLabelShowPrintOnBibDetails ) %]
 <td><a class="btn btn-default btn-xs print-label" href="/cgi-bin/koha/labels/spinelabel-print.pl?barcode=[% item.barcode | uri %]"><i class="fa fa-print"></i> Imprimir etiqueta</a></td>
 [% END %]

 [% IF CAN_user_editcatalogue_edit_items %]
 <td class="actions">
 [% IF item.can_be_edited %]
 [% IF Koha.Preference('LocalCoverImages') OR Koha.Preference('OPACLocalCoverImages') %]
 <div class="btn-group">
 <a  class="btn btn-default btn-xs" href="/cgi-bin/koha/cataloguing/additem.pl?op=edititem&biblionumber=[% item.biblionumber | html %]&itemnumber=[% item.itemnumber | html %]#edititem"><i class="fa fa-pencil"></i> Alterar</a><a class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></a>
 <ul class="dropdown-menu pull-right">
 <li><a href="/cgi-bin/koha/tools/upload-cover-image.pl?itemnumber=[% item.itemnumber | uri %]&amp;filetype=image"><i class="fa fa-upload"></i> Carregar imagem</a></li>
 </ul>
 </div>
 [% ELSE %]
 <a class="btn btn-default btn-xs" href="/cgi-bin/koha/cataloguing/additem.pl?op=edititem&biblionumber=[% item.biblionumber | html %]&itemnumber=[% item.itemnumber | html %]#edititem"><i class="fa fa-pencil"></i> Alterar</a>
 [% END %]
 [% END %]
 [% IF bundlesEnabled %]
 <button class="btn btn-default btn-xs details-control"><i class="fa fa-folder"></i> Gerir conjunto ([% item.bundled | html %]|[% item.bundled_lost | html %])</button>
 [% END %]
 </td>
 [% END %]
 </tr>
 [% END %]
 </tbody>
 </table>

[% END %][%# end of block items_table %]

[% IF Koha.Preference('EnableItemGroups') %]
 <div role="tabpanel" class="tab-pane" id="item_groups">
 [% IF CAN_user_editcatalogue_manage_item_groups %]
 <div class="item_groups_table_table_controls">
 <a href="#" class="item-group-create btn btn-default btn-xs"><i class="fa fa-plus"></i> Novo grupo de exemplares</a>
 </div>
 [% END %]
 <table class="items-group-table" id="items-group-table">
 <thead>
 <tr>
 <th>Mostrar ordem</th>
 <th>Descrição</th>
 <th class="NoSort">&nbsp;</th>
 </tr>
 </thead>
 </table>
 </div>
[% END %]


<div role="tabpanel" class="tab-pane" id="holdings">

[% IF ( Koha.Preference('NovelistSelectStaffEnabled') && Koha.Preference('NovelistSelectStaffProfile') && Koha.Preference('NovelistSelectStaffView') == 'above' ) %]
 <span class="results_summary NovelistSelect" style="display:none;">
 <span class="label">Escolha romancista: </span>
 <div data-novelist-novelistselect=[% normalized_isbn | html %]></div>
 </span>
[% END %]

[% IF ( count ) %]
 [% IF ( showncount ) %]
 [% PROCESS items_table tab="holdings" items=itemloop %]
 [% END %]
 [% IF ( hiddencount ) %]
 <p><a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=[% biblionumber | uri %]&amp;showallitems=1">Ver todos os exemplares ([% hiddencount | html %] escondidos)</a>
 [% END %] 
 [% IF ( debug_display ) %]
 <br /><br />
 <table>
 <tr><td>itemdata_enumchron</td><td>[% itemdata_enumchron | html %]</td></tr>
 <tr><td>itemdata_copynumber</td><td>[% itemdata_copynumber | html %]</td></tr>
 <tr><td>periódico</td><td>[% serial | html %]</td></tr>
 </table>
 [% END %]
[% ELSE %]
 [% IF ( ALTERNATEHOLDINGS ) %]
 [% FOREACH ALTERNATEHOLDING IN ALTERNATEHOLDINGS %]
 <div id="alternateholdings"><span class="holdings_label">Exemplares:</span> [% ALTERNATEHOLDING.holding | html %]</div>
 [% END %]
 [% ELSE %]
 <div id="noitems">Não existem exemplares desta referência</div>
 [% END %]
[% END %]

[% IF ( Koha.Preference('NovelistSelectStaffEnabled') && Koha.Preference('NovelistSelectStaffProfile') && Koha.Preference('NovelistSelectStaffView') == 'below' ) %]
 <span class="results_summary NovelistSelect" style="display:none;">
 <span class="label">Escolha romancista: </span>
 <div data-novelist-novelistselect=[% normalized_isbn | html %]></div>
 </span>
[% END %]
 </div>

[% IF (SeparateHoldings) %]
 <div role="tabpanel" class="tab-pane" id="otherholdings">
 [% IF (otheritemloop.size) %]
 [% PROCESS items_table tab="otherholdings" items=otheritemloop %]
 [% ELSE %]
 <span class="nootheritems">Sem outros exemplares.</span>
 [% END %]
 </div>
[% END %]

[% IF ( MARCNOTES ) %]

<div role="tabpanel" class="tab-pane" id="description">
<div class="content_set">

 [% FOREACH MARCNOTE IN MARCNOTES %]
 <p>
 [% IF MARCNOTE.marcnote.match('^https?://\S+$') %]
 <a href="[% MARCNOTE.marcnote | url %]">[% MARCNOTE.marcnote | html %]</a>
 [% ELSE %]
 [% MARCNOTE.marcnote | html | html_line_break %]
 [% END %]
 </p>
[% END %]
</div>
</div>

[% END %]

[% IF ComponentParts && ComponentParts.size %]
<div role="tabpanel" class="tab-pane" id="components">
 <div class="content_set">
 <table>
 [% FOR PART IN ComponentParts %]
 <tr>
 <td>
 [% PART | $raw %]
 </td>
 </tr>
 [% END %]
 </table>
 [% IF ComponentParts.size == Koha.Preference('MaxComponentRecords')%]
 <p>Apenas [% ComponentParts.size | html %] resultados são mostrados: <a href="/cgi-bin/koha/catalogue/search.pl?q=[% ComponentPartsQuery | url %]"/>mostrar todas as partes componentes</a></p>
 [% END %]
 </div> <!-- /.content_set -->
</div> <!-- /#components -->

[% END %]

[% IF ( subscriptionsnumber ) %]
<div role="tabpanel" class="tab-pane" id="subscriptions">
<div id="catalogue_detail_subscriptions">
 <h2>Assinatura de periódico</h2>
 <p> (Existem [% subscriptionsnumber | html %] assinatura(s) deste título).</p> 
 [% FOREACH subscription IN subscriptions %]
 [% IF subscription.branchcode %]
 <h3>Na biblioteca: [% Branches.GetName(subscription.branchcode) || subscription.branchcode | html %]</h3>
 [% END %]
 [% IF ( subscription.closed ) %]<p>A assinatura está fechada.</p>[% END %]
 [% IF ( subscription.location ) %]<p class="subscription_location">Localização: [% AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.location', authorised_value => subscription.location ) | html %]</p>[% END %]
 [% IF ( subscription.callnumber ) %]<p>Cota: [% subscription.callnumber | html %] </p>[% END %]
 [% IF ( subscription.subscriptionnotes ) %]<p>[% subscription.subscriptionnotes | html | html_line_break %] </p>[% END %]
 [% IF ( subscription.missinglist ) %]<p>Números em falta: [% subscription.missinglist | html %] </p>[% END %]
 [% IF ( subscription.librariannote ) %]<p>([% subscription.librariannote | html %])</p>[% END %]
 [% IF ( subscription.latestserials ) %]
 <p> Os [% subscription.staffdisplaycount | html %] últimos número relacionados com esta assinatura:</p>
 <table>
 <tr>
 <th>Número #</th>
 <th>Data de recepção</th>
 <th>Data de publicação</th>
 <th>Data de publicação (texto)</th>
 <th>Estado</th>
 <th>Nota</th>
 </tr>
 [% FOREACH latestserial IN subscription.latestserials %]
 <tr>
 <td>[% latestserial.serialseq | html %]</td>
 <td data-order="[% latestserial.planneddate | html %]">[% latestserial.planneddate | $KohaDates %]</td>
 <td data-order="[% latestserial.publisheddate | html %]">[% latestserial.publisheddate | $KohaDates %]</td>
 <td>[% latestserial.publisheddatetext | html %]</td>
 <td>
 [% INCLUDE 'serial-status.inc' serial = latestserial %]
 </td>
 <td>[% latestserial.notes | html %]</td>
 </tr>
 [% END %]
 </table>
 [% END %]
 [% IF ( CAN_user_serials ) %]
 <p>
 <a class="btn btn-link" href="/cgi-bin/koha/serials/subscription-detail.pl?subscriptionid=[% subscription.subscriptionid | uri %]"><i class="fa fa-list" aria-hidden="true"></i> Detalhes da assinatura</a>
 </p>
 [% END %]
 [% END %]
</div>
</div>
[% END %]

[% IF Koha.Preference('AcquisitionDetails') %]
<div role="tabpanel" class="tab-pane" id="acq_details">
 [% IF orders.count %]
 <table id="orders">
 <thead>
 <tr>
 <th>Fornecedor</th>
 <th>Factura</th>
 <th>Grupo de cestos</th>
 <th>Cesto</th>
 <th>Número da encomenda</th>
 <th>Data de criação</th>
 <th>Data de recepção</th>
 <th>Estado</th>
 <th>Quantidade</th>
 <th title="Custo estimado com impostos incluídos enquanto estiver pendente, custo real com imposto incluído assim que recebido">Preço</th>
 <th>Nota interna</th>
 <th>Assinatura</th>
 <th>Cota da assinatura</th>
 </tr>
 </thead>
 <tbody>
 [% FOR order IN orders %]
 [% SET basket = order.basket %]
 [% SET vendor = basket.bookseller %]
 <tr>
 <td>
 <a href="/cgi-bin/koha/acqui/supplier.pl?booksellerid=[% vendor.id | uri %]" title="Páigina de detalhes do fornecedor">[% vendor.name | html %]</a>
 </td>
 <td>
 [% IF order.invoiceid %]
 [% IF CAN_user_acquisition %]
 <a href="/cgi-bin/koha/acqui/invoice.pl?invoiceid=[% order.invoiceid | uri %]" title="Detalhes da fatura">
 [% order.invoice.invoicenumber | html %]</a>
 [% ELSE %]
 [% order.invoice.invoicenumber | html %]
 [% END %]
 [% END %]
 </td>
 <td>
 [% IF basket.basketgroupid %]
 [% SET basket_group = basket.basket_group %]
 [% IF CAN_user_acquisition_group_manage %]
 <a href="/cgi-bin/koha/acqui/basketgroup.pl?op=add&booksellerid=[% vendor.id | uri %]&basketgroupid=[% basket_group.id | uri %]">[% basket_group.name | html%] ([% basket_group.id | html %])</a>
 [% ELSE %]
 [% basket_group.name | html %] ([% basket_group.id | html %])
 [% END %]
 [% END %]
 </td>
 <td>[% IF CAN_user_acquisition_order_manage %]
 <a href="/cgi-bin/koha/acqui/basket.pl?basketno=[% basket.basketno | uri %]">[% basket.basketname | html %] ([% basket.basketno | html %])</a>
 [% ELSE %]
 [% basket.basketname | html %] ([% basket.basketno | html %])
 [% END %]</td>
 <td>[% order.ordernumber | html %]</td>
 <td data-order="[% basket.creationdate | uri %]">[% basket.creationdate | $KohaDates%]</td>
 <td data-order="[% order.datereceived | uri %]">[% order.datereceived | $KohaDates%]</td>
 <td>
 [% SWITCH order.orderstatus %]
 [% CASE 'new' %]<span>Novo</span>
 [% CASE 'ordered' %]<span>Encomendado</span>
 [% CASE 'partial' %]<span>Parcial</span>
 [% CASE 'complete' %]<span>Completa</span>
 [% CASE 'cancelled' %]<span>Cancelado</span>
 [% END %]
 </td>
 <td>[% order.quantity | html %]</td>
 <td>[% IF ( order.orderstatus == "complete" ) %][% order.unitprice_tax_included | $Price %][% ELSE %][% order.ecost_tax_included | $Price %][% END %]
 <td>[% order.order_internalnote | html %]</td>
 <td>
 [% IF order.subscriptionid %]
 <a href="/cgi-bin/koha/serials/subscription-detail.pl?subscriptionid=[% order.subscriptionid | uri %]">[% order.subscriptionid | html %]</a>
 [% END %]
 </td>
 <td>
 [% IF order.subscriptionid %]
 [% order.subscription.callnumber | html %]
 [% END %]
 </td>
 </tr>
 [% END %]
 </tbody>
 </table>
 [% ELSE %]
 <span class="noorder">Não existem encomendas para este registo bibliográfico.</span>
 [% END %]
</div>
[% END %]

[% IF suggestions.count %]
 <div role="tabpanel" class="tab-pane" id="suggestion_details">
 [% IF nb_archived_suggestions > 0 %]
 <p>[% tnpx('pluralization', 'There is one archived suggestion.', 'There are {count} archived suggestions.', nb_archived_suggestions, { count = nb_archived_suggestions }) | $raw  %]
 [% END %]
 <table id="suggestions" class="sorted">
 <thead>
 <tr>
 <th class="NoSort">&nbsp;</th>
 <th class="anti-the">Sugestão</th>
 <th>Sugerido por - em</th>
 <th>Gerido por - em</th>
 <th>Última modificação por - em</th>
 <th>Biblioteca</th>
 <th>Fundo</th>
 <th>Estado</th>
 </tr>
 </thead>
 <tbody>
 [% FOREACH suggestion IN suggestions %]
 <tr>
 <td>[% suggestion.suggestionid | html %]</td>
 <td>
 <a href="/cgi-bin/koha/suggestion/suggestion.pl?suggestionid=[% suggestion.suggestionid | uri %]&op=show" title="sugestão">
 [% suggestion.title | html %][% IF ( suggestion.author ) %], por [% suggestion.author | html %][% END %]</a>
 <br />
 [% IF ( suggestion.copyrightdate ) %]&copy; [% suggestion.copyrightdate | html %] [% END %] [% IF ( suggestion.volumedesc ) %]; Volume:<em>[% suggestion.volumedesc | html %]</em> [% END %] [% IF ( suggestion.isbn ) %]; ISBN:<em>[% suggestion.isbn | html %]</em> [% END %][% IF ( suggestion.publishercode ) %]; Publicado por [% suggestion.publishercode | html %] [% END %][% IF ( suggestion.publicationyear ) %] em <em>[% suggestion.publicationyear | html %]</em> [% END %][% IF ( suggestion.place ) %] em <em>[% suggestion.place | html %]</em> [% END %][% IF ( suggestion.collectiontitle ) %]; [% suggestion.collectiontitle | html %] [% END %][% IF ( suggestion.itemtype ) %]; [% AuthorisedValues.GetByCode( 'SUGGEST_FORMAT', suggestion.itemtype, 0 ) | html %] [% END %]<br />[% IF ( suggestion.note ) %]<div class="suggestion_note"><i class="fa fa-comment"></i> [% suggestion.note | html %]</div>[% END %]
 </td>
 <td>
 <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% suggestion.suggestedby | uri %]">[% INCLUDE 'patron-title.inc' patron => suggestion.suggester %]</a>
 [% IF suggestion.suggesteddate %] - [% suggestion.suggesteddate | $KohaDates %][% END %]
 </td>
 <td>
 <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% suggestion.managedby | uri %]">[% INCLUDE 'patron-title.inc' patron => suggestion.manager %]</a>
 [% IF suggestion.manageddate %] - [% suggestion.manageddate | $KohaDates %][% END %]
 </td>
 <td>
 <a href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% suggestion.lastmodificationby | uri %]">[% INCLUDE 'patron-title.inc' patron => suggestion.last_modifier %]</a>
 [% IF suggestion.lastmodificationdate %] - [% suggestion.lastmodificationdate | $KohaDates %][% END %]
 </td>
 <td>
 [% Branches.GetName( suggestion.branchcode ) | html %]
 </td>
 <td>
 [% suggestion.fund.budget_name | html %]
 </td>
 <td>
 [% IF    suggestion.STATUS == 'ASKED'     %]<span>Pendente</span>
 [% ELSIF suggestion.STATUS == 'ACCEPTED'  %]<span>Aceite</span>
 [% ELSIF suggestion.STATUS == 'ORDERED'   %]<span>Encomendado</span>
 [% ELSIF suggestion.STATUS == 'REJECTED'  %]<span>Rejeitado</span>
 [% ELSIF suggestion.STATUS == 'CHECKED'   %]<span>Activo</span>
 [% ELSIF suggestion.STATUS == 'AVAILABLE' %]<span>Disponível</span>
 [% ELSIF AuthorisedValues.GetByCode( 'SUGGEST_STATUS', suggestion.STATUS ) %]
 [% AuthorisedValues.GetByCode( 'SUGGEST_STATUS', suggestion.STATUS ) | html %]
 [% ELSE %]<span>Estado desconhecido</span>
 [% END %]
 [% IF suggestion.reason %]
 <br />([% suggestion.reason | html %])
 [% END %]
 </td>
 </tr>
 [% END %]
 </tbody>
 </table>
 </div>
[% END %]

[% IF ( FRBRizeEditions ) %][% IF ( XISBNS ) %]
<div role="tabpanel" class="tab-pane" id="editions"><h4>Edição</h4>
<table>
[% FOREACH XISBN IN XISBNS %]<tr>[% IF ( AmazonCoverImages ) %]<td><a href="http://www.amazon.com/gp/reader/[% XISBN.normalized_isbn | uri %][% AmazonAssocTag | uri %]#reader-link"><img src="https://images-na.ssl-images-amazon.com/images/P/[% XISBN.normalized_isbn | html %].01._AA75_PU_PU-5_.jpg" /></a></td>[% END %]
[% IF ( !item_level_itypes || Koha.Preference('BiblioItemtypeInfo') ) %]<td>[% IF ( noItemTypeImages ) %]<span class="itypetext">[% XISBN.description | html %]</span>[% ELSE %]<img src="[% XISBN.imageurl | html %]" alt="[% XISBN.description | html %]" title="[% XISBN.description | html %]">[% END %]</td>[% END %]
<td><a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=[% XISBN.biblionumber | uri %]">[% XISBN.title | html %]</a> <span>por</span> [% XISBN.author | html %] &copy;[% XISBN.copyrightdate | html %]
 [% IF ( XISBN.publishercode ) %]
[% XISBN.publishercode | html %] [% IF ( XISBN.place ) %]([% XISBN.place | html %])[% END %] [% IF ( XISBN.publicationyear ) %], [% XISBN.publicationyear | html %][% END %] [% IF ( XISBN.editionstatement ) %][% XISBN.editionstatement | html %][% END %] [% IF ( XISBN.editionresponsibility ) %][% XISBN.editionresponsibility | html %][% END %]
 [% END %]
 [% IF ( XISBN.pages ) %] [% END %][% XISBN.pages | html %] [% IF ( XISBN.illus ) %][% XISBN.illus | html %][% END %]
 [% IF ( XISBN.size ) %], [% END %][% XISBN.size | html %]
</td>

[% END %]
</table></div>[% END %]
[% END %]

[% IF ( ( Koha.Preference('CatalogConcerns') || Koha.Preference('OpacCatalogConcerns') ) && CAN_user_editcatalogue_edit_catalogue ) %]
<div role="tabpanel" class="tab-pane" id="concerns">
 <fieldset class="action" style="cursor:pointer;">
 <a id="hideResolved"><i class="fa fa-minus-square"></i> Esconder resolvidos</a>
 | <a id="showAll"><i class="fa fa-bars"></i> Mostrar todos</a>
 </fieldset>

 <table id="table_concerns" width="100%">
 <thead>
 <tr>
 <th>Reportado</th>
 <th>Detalhes</th>
 <th>Estado</th>
 <th data-class-name="actions noExport">Ações</th>
 </tr>
 </thead>
 </table>
</div>
[% END %]

[% IF ( LocalCoverImages ) %]
 <div role="tabpanel" class="tab-pane" id="images">
 [% IF localimages.count %]
 <p>Clicar numa imagem para a ver no visualizador de imagens</p>
 <ul class="thumbnails">
 [% FOREACH image IN localimages %]
 [% IF image %]
 <li id="imagenumber-[% image.imagenumber | html %]" class="thumbnail">
 <a href="/cgi-bin/koha/catalogue/imageviewer.pl?biblionumber=[% biblionumber | uri %]&amp;imagenumber=[% image.imagenumber | uri %]">
 <img src="/cgi-bin/koha/catalogue/image.pl?thumbnail=1&amp;imagenumber=[% image.imagenumber | uri %]" />
 </a>
 [% IF CAN_user_tools_upload_local_cover_images %]
 <a href="#" class="remove"><i class="fa fa-trash"></i> Eliminar imagem</a>
 [% END %]
 </li>
 [% END %]
 [% END %]
 </ul>
 [% ELSE # - No image passed JavaScript takes care %]
 <span class="noimagesuploaded">Nenhuma imagem carregada para este registo bibliográfico.</span>
 [% END %]
 [% IF ( CAN_user_tools_upload_local_cover_images ) %]
 <p>Carregar uma imagem: <a class="btn btn-default btn-xs" href="/cgi-bin/koha/tools/upload-cover-image.pl?biblionumber=[% biblionumber | uri %]&amp;filetype=image"><i class="fa fa-upload" aria-hidden="true"></i> Carregar</a>
 </p>
 [% END %]
 </div>
[% END %]

[% IF ( HTML5MediaEnabled ) %]
<div role="tabpanel" class="tab-pane" id="html5media">
 [% FOREACH HTML5MediaSet IN HTML5MediaSets %]
 <p>
 [% IF HTML5MediaSet.is_youtube %]
 <iframe id="player" width="640" height="360" src="[% HTML5MediaSet.srcblock | url %]"></iframe>
 [% ELSE %] <[% HTML5MediaParent | html %] controls preload=none> <[% HTML5MediaSet.child | html %] src="[% HTML5MediaSet.srcblock | url %]"[% HTML5MediaSet.typeblock | html %] /> [etiqueta [% HTML5MediaParent | html %] não suportado pelo seu browser.] </[% HTML5MediaParent | html %]>
 [% END %]
 </p>
 [% END %]
</div>
[% END %]


[% IF ( Koha.Preference('NovelistSelectStaffEnabled') && Koha.Preference('NovelistSelectStaffProfile') && Koha.Preference('NovelistSelectStaffView') == 'tab' ) %]
 <div role="tabpanel" class="tab-pane" id="NovelistSelect" class="novelistSelect">
 <div data-novelist-novelistselect=[% normalized_isbn | html %]></div>
 </div>
[% END %]

[% FOREACH plugins_intranet_catalog_biblio_tab IN plugins_intranet_catalog_biblio_tabs %]
 <div role="tabpanel" class="tab-pane" id="[% plugins_intranet_catalog_biblio_tab.id | html %]">
 [% plugins_intranet_catalog_biblio_tab.content | $raw %]
 </div>
[% END %]

</div><!-- /tab-content -->
</div><!-- /bibliodetails -->

<div id="export" style="margin-top: 1em;">
<form method="get" action="/cgi-bin/koha/catalogue/export.pl">
<table> <tr>
 <th>Guardar registo</th> </tr>
 <tr><td> Seleccionar formato de download: <select name="format">
 <option value="mods">MODS (XML)</option>
 <option data-toggle="modal" data-target="#exportModal_">Dublin Core</option>
 <option value="marcxml">MARCXML</option>
 <option value="marc8">MARC (non-Unicode/MARC-8)</option>
 <option value="utf8">MARC (Unicode/UTF-8)</option> </select>
 <input class="btn btn-primary" name="save" type="submit" value="Download do registo" /></td>
 </tr>
 <tr><td>
 <input type="hidden" name="op" value="export" /><input type="hidden" name="bib" value="[% biblionumber | html %]" />
 </td></tr>
</table>
</form>
</div>

<div id="marcPreview" class="modal" tabindex="-1" role="dialog" aria-labelledby="marcPreviewLabel" aria-hidden="true">
 <div class="modal-dialog modal-lg">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="marcPreviewLabel">Pré-visualização MARC</h3>
 </div>
 <div class="modal-body">
 <div id="loading"> <img src="[% interface | html %]/[% theme | html %]/img/spinner-small.gif" alt="" /> A carregar </div>
 </div>
 <div class="modal-footer">
 <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Fechar</button>
 </div>
 </div>
 </div>
</div>

<div id="elasticPreview" class="modal" tabindex="-1" role="dialog" aria-labelledby="elasticPreviewLabel" aria-hidden="true">
 <div class="modal-dialog modal-lg">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="elasticPreviewLabel">Registo no Elasticsearch</h3>
 </div>
 <div class="modal-body">
 <div id="loading"> <img src="[% interface | html %]/[% theme | html %]/img/spinner-small.gif" alt="" /> A carregar </div>
 </div>
 <div class="modal-footer">
 <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Fechar</button>
 </div>
 </div>
 </div>
</div>

 </main>
 </div> <!-- /.col-sm-10.col-sm-push-2 -->

 <div class="col-sm-2 col-sm-pull-10">
 <aside>
 [% INCLUDE 'biblio-view-menu.inc' %]
 </aside>
 </div> <!-- /.col-sm-2.col-sm-pull-10 -->
 </div> <!-- /.row -->

[% END %]

<div class="modal fade" id="modal-item-group-create" tabindex="-1" role="dialog" aria-labelledby="modal-item-group-create-label">
 <div class="modal-dialog">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="modal-item-group-create-label"><i class="fa fa-plus"></i> Criar um novo grupo de exemplares</h3>
 </div>
 <form id="modal-item-group-create-form" class="validated">
 <div class="modal-body">
 <fieldset>
 <p>
 <label for="item_group_description" class="required">Nome: </label>
 <input name="description" id="modal-item-group-create-form-description" type="text" size="30" required="required" class="required" />
 <span class="required">Obrigatório</span>
 </p>
 <p>
 <label for="item_group_display_order" class="required">Ordem de visualização: </label>
 <input name="display_order" id="modal-item-group-create-form-display_order" value="0" size="5" required="required" class="required" />
 <span class="required">Obrigatório</span>
 <br/>
 <span class="hint">Números apenas, os grupos de exemplares serão exibidos por ordem de contagem</span>
 </p>
 </fieldset>
 </div>
 <div class="modal-footer">
 <button id="modal-item-group-create-submit" class="btn btn-default"><i class="fa fa-plus"></i> Submeter</button>
 <button class="btn btn-link" data-dismiss="modal" aria-hidden="true">Anular</button>
 </div>
 </form>
 </div>
 </div>
</div>

<div class="modal fade" id="modal-item-group-edit" tabindex="-1" role="dialog" aria-labelledby="modal-item-group-edit-label">
 <div class="modal-dialog">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="modal-item-group-edit-label"><i class='fa fa-edit'></i> Editar grupo de exemplares</h3>
 </div>
 <form id="modal-item-group-edit-form" class="validated">
 <div class="modal-body">
 <fieldset>
 <p>
 <label for="item_group_description" class="required">Nome: </label>
 <input name="description" id="modal-item-group-edit-form-description" type="text" size="30" required="required" class="required" />
 <span class="required">Obrigatório</span>
 </p>
 <p>
 <label for="item_group_display_order" class="required">Ordenação: </label>
 <input name="display_order" id="modal-item-group-edit-form-display_order" size="5" />
 <span class="hint">Números apenas, os grupos de exemplares serão exibidos por ordem de contagem</span>
 </p>
 </fieldset>
 </div>
 <div class="modal-footer">
 <button id="modal-item-group-edit-submit" class="btn btn-default"><i class='fa fa-edit'></i> Submeter</button>
 <button class="btn btn-link" data-dismiss="modal" aria-hidden="true">Anular</button>
 </div>
 </form>
 </div>
 </div>
</div>

<div class="modal fade" id="modal-item-group-delete" tabindex="-1" role="dialog" aria-labelledby="modal-item-group-delete-label">
 <div class="modal-dialog">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="modal-item-group-delete-label"><i class='fa fa-trash'></i> Eliminar grupo de exemplares</h3>
 </div>
 <div class="modal-body">
 Tem a certeza que pretende eliminar este grupo de exemplares? </div>
 <div class="modal-footer">
 <button id="modal-item-group-delete-submit" class="btn btn-danger"><i class='fa fa-trash'></i> Apagar</button>
 <button class="btn btn-link" data-dismiss="modal" aria-hidden="true">Anular</button>
 </div>
 </div>
 </div>
</div>

<div class="modal fade" id="modal-item-group-set" tabindex="-1" role="dialog" aria-labelledby="modal-item-group-set-label">
 <div class="modal-dialog">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="modal-item-group-set-label"><i class='fa fa-book'></i> Definir grupo para os exemplares</h3>
 </div>
 <form id="modal-item-group-set-form" class="validated">
 <div class="modal-body">
 <fieldset>
 <p>
 <label for="item_group" class="required">Grupo de exemplares: </label>
 <select name="item_group" id="item-group-add-form-select">
 [% FOREACH ig IN biblio.item_groups %]
 <option value="[% ig.id | html %]">[% ig.description | html %]</option>
 [% END %]
 </select>
 <span class="required">Obrigatório</span>
 </p>
 </fieldset>
 </div>
 <div class="modal-footer">
 <button id="modal-item-group-set-submit" class="btn btn-default"><i class='fa fa-book'></i> Definir grupo de exemplares</button>
 <button class="btn btn-link" data-dismiss="modal" aria-hidden="true">Anular</button>
 </div>
 </form>
 </div>
 </div>
</div>

<div class="modal fade" id="modal-item-group-unset" tabindex="-1" role="dialog" aria-labelledby="modal-item-group-unset-label">
 <div class="modal-dialog">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="modal-item-group-unset-label"><i class='fa fa-unlink'></i> Remover do grupo de exemplares</h3>
 </div>
 <div class="modal-body">
 Tem a certeza que pretende remover este(s) exemplar(es) dos grupos de exemplares? </div>
 <div class="modal-footer">
 <button id="modal-item-group-unset-submit" class="btn btn-danger"><i class='fa fa-unlink'></i> Remover</button>
 <button class="btn btn-link" data-dismiss="modal" aria-hidden="true">Anular</button>
 </div>
 </div>
 </div>
</div>

 [% IF bundlesEnabled %]
 <div class="modal" id="addToBundleModal" tabindex="-1" role="dialog" aria-labelledby="addToBundleLabel">
 <form id="addToBundleForm" action="">
 <div class="modal-dialog" role="document">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="addToBundleLabel">Adicionar ao conjunto</h3>
 </div>
 <div class="modal-body">
 <div id="addResult"></div>
 <fieldset class="rows">
 <ol>
 <li>
 <label class="required" for="external_id">Código de barras: </label>
 <input type="text" id="external_id" name="external_id" required="required">
 <span class="required">Obrigatório</span>
 </li>
 </ol>
 </fieldset>
 </div>
 <div class="modal-footer">
 <button type="submit" class="btn btn-default">Submeter</button>
 <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Fechar</button>
 </div>
 </div>
 </div>
 </form>
 </div>

 <div class="modal" id="removeFromBundleModal" tabindex="-1" role="dialog" aria-labelledby="removeFromBundleLabel">
 <form id="removeFromBundleForm" action="">
 <div class="modal-dialog" role="document">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="removeFromBundleLabel">Remover do conjunto</h3>
 </div>
 <div class="modal-body">
 <div id="removeResult"></div>
 <fieldset class="rows">
 <ol>
 <li>
 <label class="required" for="external_id">Código de barras: </label>
 <input type="text" id="rm_external_id" name="external_id" required="required">
 <span class="required">Obrigatório</span>
 </li>
 </ol>
 </fieldset>
 </div>
 <div class="modal-footer">
 <button type="submit" class="btn btn-default">Submeter</button>
 <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Fechar</button>
 </div>
 </div>
 </div>
 </form>
 </div>
 [% END %]

 [% IF ( Koha.Preference('CatalogConcerns') ) %]
 [% INCLUDE 'modals/add_catalog_concern.inc' %]
 [% END %]

 [% IF ( ( Koha.Preference('CatalogConcerns') || Koha.Preference('OpacCatalogConcerns') ) && CAN_user_editcatalogue_edit_catalogue ) %]
 [% INCLUDE 'modals/display_ticket.inc' %]
 [% END %]

[% MACRO jsinclude BLOCK %]
 [% INCLUDE 'catalog-strings.inc' %]
 [% Asset.js("js/catalog.js") | $raw %]
 [% Asset.js("js/recalls.js") | $raw %]
 [% Asset.js("js/coce.js") | $raw %]
 [% Asset.js("lib/Chocolat/js/chocolat.js") | $raw %]
 [% IF ( Koha.Preference('CatalogConcerns') ) %]
 <script>
            /* Set a variable needed by add_catalog_concern.js */
            var logged_in_user_borrowernumber = "[% logged_in_user.borrowernumber | html %]";
        </script>
 [% Asset.js("js/modals/add_catalog_concern.js") | $raw %]
 [% END %]
 [% IF ( ( Koha.Preference('CatalogConcerns') || Koha.Preference('OpacCatalogConcerns') ) && CAN_user_editcatalogue_edit_catalogue ) %]
 <script>
            $(document).ready(function() {
                var table_settings = [% TablesSettings.GetTableSettings( 'cataloguing', 'concerns', 'table_concerns', 'json' ) | $raw %];

                var filtered = false;
                let additional_filters = {
                    resolved_date: function(){
                        if ( filtered ) {
                            return { "=": null };
                        } else {
                            return;
                        }
                    },
                    biblio_id: [% biblionumber | uri %]
                };

                var tickets_url = '/api/v1/tickets';
                var tickets = $("#table_concerns").kohaTable({
                    "ajax": {
                        "url": tickets_url
                    },
                    "embed": [
                        "reporter",
                        "resolver",
                        "updates+count",
                    ],
                    'emptyTable': '<div class="dialog message">' + _("Parabéns, não existem problemas de catalogação.") + '</div>',
                    "columnDefs": [ {
                        "targets": [0,1,2],
                        "render": function (data, type, row, meta) {
                            if ( type == 'display' ) {
                                if ( data != null ) {
                                    return data.escapeHtml();
                                }
                                else {
                                    return "";
                                }
                            }
                            return data;
                        }
                    } ],
                    "columns": [
                        {
                            "data": "reported_date:reporter.firstname",
                            "render": function(data, type, row, meta) {
                                let reported = '<span class="date clearfix">' + $datetime(row.reported_date) + '</span>';
                                reported += '<span class="reporter clearfix">' + $patron_to_html(row.reporter, {
                                    display_cardnumber: false,
                                    url: true
                                }) + '</span>';
                                return reported;
                            },
                            "searchable": true,
                            "orderable": true
                        },
                        {
                            "data": "title:body",
                            "render": function(data, type, row, meta) {
                                let resolved = ( row.resolved_date ) ? true : false;
                                let result = '<a role="button" href="#" data-toggle="modal" data-target="#ticketDetailsModal" data-concern="' + encodeURIComponent(row.ticket_id) + '" data-resolved="' + resolved + '">' + row.title + '</a>';
                                if (row.updates_count) {
                                    result += '<span class="pull-right"><a role="button" href="#" data-toggle="modal" data-target="#ticketDetailsModal" data-concern="' + encodeURIComponent(row.ticket_id) + '"><i class="fa fa-comment" aria-hidden="true"></i> ' + row.updates_count + '</a></span>';
                                }
                                result += '<div id="detail_' + row.ticket_id + '" class="hidden">' + row.body + '</div>';
                                return result;
                            },
                            "searchable": true,
                            "orderable": true
                        },
                        {
                            "data": "resolved_date",
                            "render": function(data, type, row, meta) {
                                let result = '';
                                if (row.resolved_date) {
                                    result += _("Resolvido por:") + ' <span>' + $patron_to_html(row.resolver, {
                                        display_cardnumber: false,
                                        url: true
                                    }) + '</span>';
                                    result += '<span class="clearfix">' + $datetime(row.resolved_date) + '</span>';
                                } else {
                                    result += _("Abrir");
                                }
                                return result;
                            },
                            "searchable": true,
                            "orderable": true
                        },
                        {
                            "data": function(row, type, val, meta) {
                                let resolved = ( row.resolved_date ) ? true : false;
                                let result = '<a class="btn btn-default btn-xs" role="button" href="#" data-toggle="modal" data-target="#ticketDetailsModal" data-concern="' + encodeURIComponent(row.ticket_id) + '" data-resolved="' + resolved + '"><i class="fa fa-eye" aria-hidden="true"></i> ' + _("Detalhes") + '</a>';
                                return result;
                            },
                            "searchable": false,
                            "orderable": false
                        },
                    ]
                }, table_settings, 0, additional_filters);

                $('#hideResolved').on("click", function() {
                    filtered = true;
                    tickets.DataTable().draw();
                });

                $('#showAll').on("click", function() {
                    filtered = false;
                    tickets.DataTable().draw();
                });
            });
        </script>
 [% Asset.js("js/modals/display_ticket.js") | $raw %]
 [% END %]
 <script>
        var interface = "[% interface | html %]";
        var theme = "[% theme | html %]";
        // http://www.oreillynet.com/pub/a/javascript/2003/10/21/amazonhacks.html
        function verify_cover_images() {
            // Loop over each container in the template which contains covers
            $(".cover-slider").each(function(){
                var lightbox_descriptions = [];
                var first_shown = 0;
                $(this).find(".cover-image").each( function( index ){
                var div = $(this);
                // Find the image in the container
                var img = div.find("img")[0];
                if( $(img).length > 0 ){
                    var description = "";
                        // All slides start hidden. If this is the first one, show it.
                        if( first_shown == 0 ){
                            div.show();
                            first_shown = 1;
                        }
                        // Check if Amazon image is present
                        if ( div.attr("id") == "amazon-bookcoverimg"  ) {
                            w = img.width;
                            h = img.height;
                            if ((w == 1) || (h == 1)) {
                                // Amazon returned single-pixel placeholder
                                // Remove the container
                                div.remove();
                            } else {
                                lightbox_descriptions.push(_("Imagem de capa da Amazon (<a href='%s'>ver original</a>)").format($(img).data('link')));
                            }
                        } else if( div.attr("id") == "custom-coverimg" ){
                            if ( (img.complete != null) && (!img.complete) || img.naturalHeight == 0 ) {
                                // No image was loaded via the CustomCoverImages system preference
                                // Remove the container
                                div.remove();
                            } else {
                                lightbox_descriptions.push("Custom cover image");
                            }
                        } else if ( div.attr("id") == "syndetics-bookcoverimg" ){
                                lightbox_descriptions.push(_("Imagem de capa do Syndetics (<a href='%s'>ver original</a>)").format($(img).data('link')));
                        }
                        else if( div.hasClass("coce-coverimg" ) ){
                            // Identify which service's image is being loaded by Coce
                            var coce_description;
                            if( $(img).attr("src").indexOf('amazon.com') >= 0 ){
                                coce_description = ("Coce image from Amazon.com");
                            } else if( $(img).attr("src").indexOf('google.com') >= 0 ){
                                coce_description = _("Imagem Coce do Google Books");
                            } else if( $(img).attr("src").indexOf('openlibrary.org') >= 0 ){
                                coce_description = _("Imagem Coce da Open Library");
                            }
                            div.find(".hint").html(coce_description);
                            lightbox_descriptions.push(coce_description);
                        } else if ( div.attr("class") == "cover-image local-coverimg" ) {
                            lightbox_descriptions.push(_("Imagem local de capa (<a href='%s'>editar</a>)").format($(img).data('link')));
                        } else {
                            lightbox_descriptions.push(_("Imagem de capa de fonte desconhecida"));
                        }
                    }
                });

                // Lightbox for cover images
                Chocolat(this.querySelectorAll('.cover-image a'), {
                    description: function(){
                        return lightbox_descriptions[this.settings.currentImageIndex];
                    }
                });

            });

            $(".cover-slider").each(function(){
                var coverSlide = this;
                var coverImages = $(this).find(".cover-image");
                if( coverImages.length > 1 ){
                    coverImages.each(function( index ){
                        // If more that one image is present, add a navigation link
                        // for activating the slide
                        var covernav = $("<a href=\"#\" data-num=\"" + index + "\" class=\"cover-nav\"></a>");
                        if( index == 0 ){
                            // Set the first navigation link as active
                            $(covernav).addClass("nav-active");
                        }
                        $(covernav).html("<i class=\"fa fa-circle\"></i>");
                        $(coverSlide).append( covernav );
                    });
                }

                if( $(coverSlide).attr('id') == 'biblio-cover-slider' // Hide if not visible, but only for the biblio images. Images for items are only local cover images
                    && $(coverSlide).find(".cover-image:visible").length < 1 ){
                    $(coverSlide).remove();
                } else {
                    $(coverSlide).addClass("cover-slides");
                    var img = $(coverSlide).find(".cover-image:visible").find("img")[0];
                    if( $(img).length > 0 && img.complete && img.naturalHeight > 0 ){
                        $(".cover-slides").css({"background-image":"none"});
                    }
                }
            });

            $("#editions img").each(function(i){
                if ( this.src.indexOf('amazon.com') >= 0 ) {
                    w = this.width;
                    h = this.height;
                    if ((w == 1) || (h == 1)) {
                        this.src = 'https://images-na.ssl-images-amazon.com/images/G/01/x-site/icons/no-img-sm.gif';
                    } else if ( (this.complete != null) && (!this.complete) || this.naturalHeight == 0 ) {
                        this.src = 'https://images-na.ssl-images-amazon.com/images/G/01/x-site/icons/no-img-sm.gif';
                    }
                }
            });
        }

        function removeLocalImage(imagenumber) {
            var thumbnail = $("#imagenumber-" + imagenumber );
            var copy = thumbnail.html();
            thumbnail.find("img").css("opacity", ".2");
            thumbnail.find("a.remove").html("<img style='display:inline-block' src='" + interface + "/" + theme + "/img/spinner-small.gif' alt='' />");
            $.ajax({
                url: "/cgi-bin/koha/svc/cover_images?action=delete&imagenumber=" + imagenumber,
                success: function(data) {
                    $(data).each( function(i) {
                        if ( this.deleted == 1 ) {
                            thumbnail.remove();
                        } else {
                            thumbnail.html( copy );
                            alert(_("Ocorreu um erro ao eliminar esta image"));
                        }
                        if ( $('ul.thumbnails > li').length == 0 ) {
                            showNoImageMessage();
                        }
                    });
                },
                error: function(data) {
                    thumbnail.html( copy );
                    alert(_("Ocorreu um erro ao eliminar esta image"));
                }
            });
        }

        function showNoImageMessage() {
            var no_images_msg = _("Nenhuma imagem carregada para este registo bibliográfico.");
            no_images_msg = '<p>' + no_images_msg + '</p>';
            [% IF ( CAN_user_tools_upload_local_cover_images ) %]
                var please_upload = _("Carregar uma image: %sCarregar%s").format("<a class='btn btn-default btn-xs' href='/cgi-bin/koha/tools/upload-cover-image.pl?biblionumber=" + biblionumber + "&amp;filetype=image'><i class='fa fa-upload' aria-hidden='true'></i> ","</a>");
                no_images_msg += "<p id='upload_image'>" + please_upload + '</p>';
            [% END %]
            $('#images').html(no_images_msg);
        }

        [% IF StaffDetailItemSelection %]
            function itemSelectionBuildDeleteLink(div) {
                var itemnumbers = new Array();
                $("input[name='itemnumber'][type='checkbox']:checked", div).each(function() {
                    itemnumbers.push($(this).val());
                });
                if (itemnumbers.length > 0) {
                    var url = '/cgi-bin/koha/tools/batchMod.pl?op=show&del=1';
                    url += '&itemnumber=' + itemnumbers.join('&itemnumber=');
                    url += '&biblionumber=[% biblionumber | uri %]';
                    url += '&src=CATALOGUING';
                    $('a.itemselection_action_delete').attr('href', url);
                } else {
                    return false;
                }
                return true
            }

            function itemSelectionBuildModifyLink(div) {
                var itemnumbers = new Array();
                $("input[name='itemnumber'][type='checkbox']:checked", div).each(function() {
                    itemnumbers.push($(this).val());
                });
                if (itemnumbers.length > 0) {
                    var url = '/cgi-bin/koha/tools/batchMod.pl?op=show';
                    url += '&itemnumber=' + itemnumbers.join('&itemnumber=');
                    url += '&biblionumber=[% biblionumber | uri %]';
                    url += '&src=CATALOGUING';
                    $('a.itemselection_action_modify').attr('href', url);
                } else {
                    return false;
                }
                return true;
            }

            function itemSelectionBuildActionLinks(tab) {
                var div = $("#" + tab);
                var delete_link_ok = itemSelectionBuildDeleteLink(div);
                var modify_link_ok = itemSelectionBuildModifyLink(div);
                if (modify_link_ok || delete_link_ok) {
                    $('.itemselection_actions', div).show();
                } else {
                    $('.itemselection_actions', div).hide();
                }
            }

            $(document).ready(function() {
                $('table.items_table').each(function() {
                    var div = $(this).parent().attr("id");
                    itemSelectionBuildActionLinks(div);
                });

                $("input[name='itemnumber'][type='checkbox']").change(function() {
                    var div = $(this).parents('table').parent().parent().attr("id");
                    itemSelectionBuildActionLinks(div);
                });

                $(".SelectAll").on("click",function(e){
                    e.preventDefault();
                    var tab = $(this).data("tab");
                    $("input[name='itemnumber'][type='checkbox']", $("#"+tab)).prop('checked', true);
                    itemSelectionBuildActionLinks(tab);
                });

                $(".ClearAll").on("click",function(e){
                    e.preventDefault();
                    var tab = $(this).data("tab");
                    $("input[name='itemnumber'][type='checkbox']", $("#"+tab)).prop('checked', false);
                    itemSelectionBuildActionLinks(tab);
                });
            });
        [% END %]

        $(document).ready(function() {
            // Pick details tab to display by default
            [% IF count == 0 %]
                [% IF ( Koha.Preference('HTML5MediaEnabled') == 'staff' or Koha.Preference('HTML5MediaEnabled') == 'both' ) && HTML5MediaSets.size %]
                    $(".nav-tabs a[href='#html5media']").tab("show");
                [% ELSIF ComponentParts && ComponentParts.size %]
                    $(".nav-tabs a[href='#components']").tab("show");
                [% ELSE %]
                    $(".nav-tabs a[href='#holdings']").tab("show");
                [% END %]
            [% ELSE %]
                $(".nav-tabs a[href='#holdings']").tab("show");
            [% END %]
            $('#search-form').focus();
            $('.thumbnails > li > .remove').click(function() {
                var result = confirm(_("Tem a certeza que pretende eliminar esta imagem de capa?"));

                if ( result == true ) {
                    var imagenumber = $(this).parent().attr('id').split('-')[1];
                    removeLocalImage(imagenumber);
                }

                return false;
            });
            [% IF ( IntranetCoce && CoceProviders ) %]
                KOHA.coce.getURL('[% CoceHost | html %]', '[% CoceProviders | html %]');
            [% END %]

            $("body").on("click",".previewMARC", function(e){
                e.preventDefault();
                var page = $(this).attr("href");
                $("#marcPreview .modal-body").load(page + " table");
                $('#marcPreview').modal({show:true});

            });

           [% IF ( Koha.Preference('SearchEngine') == 'Elasticsearch' ) %]
            $("body").on("click",".previewElastic", function(e){
                e.preventDefault();
                var pageElastic = $(this).attr("href");
                $("#elasticPreview .modal-body").load(pageElastic, function( response, status, xhr ) {
                    if( status == 'error' ){
                        $("#elasticPreview .modal-body").html("<h1>"+_("Ocorreu um erro!")+"</h1><h2><em>"+_("Erro 404")+"</em></h2><ul><li>"+_("Este erro significa que o endereço foi quebrado e que a página não existe.")+"</li></ul><h3>"+_("O que se segue?")+"</h3><ul style='margin-bottom: 1em; padding-bottom: 1em; border-bottom: 1px solid #CCC;'><li>"+_("Use a barra de menu superior para navegar para outra parte do Koha.")+"</li><li>"+_("Para reportar um link quebrado ou outro problema, por favor contacte o administrador do Koha.")+" <a href='mailto:[% Koha.Preference("KohaAdminEmailAddress") | uri %]'>"+_("Send email")+"</a></li></ul>");
                    }
                });
                $('#elasticPreview').modal({show:true});
            });
           [% END %]

            [% IF ( Koha.Preference('NovelistSelectStaffEnabled') && Koha.Preference('NovelistSelectStaffProfile') && ( normalized_isbn || normalized_upc ) ) %]
                novSelect.loadContentForQuery({
                    ClientIdentifier : '[% IF normalized_isbn %][% normalized_isbn | html %][% ELSE %][% normalized_upc | html %][% END %]',
                    ISBN : '[% IF normalized_isbn %][% normalized_isbn | html %][% ELSE %][% normalized_upc | html %][% END %]',
                    version : '2.1'
                },
                '[% Koha.Preference('NovelistSelectStaffProfile') | html %]',
                '[% Koha.Preference('NovelistSelectPassword') | html %]',
                function(d){
                    if ( d.length > 0 ){ //If no content
                        $(".NovelistSelect").show();
                    }
                 });
             [% END %]
             $(".print-label").on("click", function(e){
                e.preventDefault();
                link = $(this).attr("href");
                openWindow(link,"Print spine label",400,400);
             });
             $(".cover-slider").on("click",".cover-nav", function(e){
                 e.preventDefault();
                var cover_slider = $(this).parent();
                // Adding click handler for cover image navigation links
                var num = $(this).data("num");
                $(cover_slider).find(".cover-nav").removeClass("nav-active");
                $(this).addClass("nav-active");
                $(cover_slider).find(".cover-image").hide();
                $(cover_slider).find(".cover-image").eq( num ).show();
             });
        });


        [% IF ( IntranetCoce && CoceProviders ) %]
            let counter_wait = 0;
            function wait_for_images(cb){

                var loaded = 1;
                counter_wait++;

                if ( loaded ) {
                    loaded = KOHA.coce.done;
                }

                if (!loaded && counter_wait < 50) {// Do not wait more than 5 seconds
                    window.setTimeout(function(){wait_for_images(cb);}, 100);
                } else {
                    if (counter_wait >= 50 ) {
                        console.log("Could not retrieve the images")
                    }
                    cb();
                }
            }

            $(window).load(function() {
                wait_for_images(verify_cover_images);
            });
        [% ELSE %]
            $(window).load(function() {
                verify_cover_images();
            });
        [% END %]
    </script>
 [% IF ( Koha.Preference('NovelistSelectStaffEnabled') && Koha.Preference('NovelistSelectStaffProfile') && ( normalized_isbn || normalized_upc ) ) %]
 <script src="https://imageserver.ebscohost.com/novelistselect/ns2init.js"></script>
 [% END %]
 [% INCLUDE 'datatables.inc' %]
 [% Asset.js("lib/jquery/plugins/jquery.dataTables.columnFilter.js") | $raw %]
 [% INCLUDE 'columns_settings.inc' %]
 [% INCLUDE 'js-date-format.inc' %]
 [% INCLUDE 'js-patron-format.inc' %]
 [% INCLUDE 'js-biblio-format.inc' %]
 [% Asset.js("js/browser.js") | $raw %]
 [% Asset.js("js/table_filters.js") | $raw %]
 <script>
        var browser;
        browser = KOHA.browser('[% searchid | html %]', parseInt(biblionumber, 10));
        browser.show();

        [% IF bundlesEnabled %]
        var bundle_settings = [% TablesSettings.GetTableSettings('catalogue', 'detail','bundle_tables','json') | $raw %];
        var bundle_lost_value = [% Koha.Preference('BundleLostValue') | html %];
        [% END %]
        $(document).ready(function() {

            [% IF bundlesEnabled %] // Bundle handling
            function createChild ( row, itemnumber, duedate ) {

                // Toolbar
                var bundle_toolbar = $('<div id="toolbar" class="btn-toolbar"></div>');
                bundle_toolbar.append('<a class="btn btn-default" data-toggle="modal" data-target="#addToBundleModal" data-item="' + itemnumber + '"><i class="fa fa-plus"></i> ' + _("Adicionar ao conjunto") + '</a>');
                bundle_toolbar.append('<a class="btn btn-default" data-toggle="modal" data-target="#removeFromBundleModal" data-item="' + itemnumber + '"><i class="fa fa-minus"></i> ' + _("Remover do conjunto") + '</a>');

                // Disable management if there's a duedate
                if(duedate) {
                    bundle_toolbar.children('.btn').addClass("disabled");
                    bundle_toolbar.attr("title", _("Este conjunto está emprestado, não pode ser modificado"));
                }

                // This is the table we'll convert into a DataTable
                var bundles_table = $('<table class="display tbundle" data-itemnumber="'+itemnumber+'" id="bundle_table_'+itemnumber+'" width="100%"/>');

                // Display it the child row
                row.child( bundle_toolbar.add(bundles_table), 'bundle' ).show();

                // Initialise as a DataTable
                var bundle_table_url = "/api/v1/items/" + itemnumber + "/bundled_items?";
                var bundle_table = bundles_table.kohaTable({
                    "ajax": {
                        "url": bundle_table_url
                    },
                    "embed": [
                        "biblio",
                        "return_claim.patron"
                    ],
                    "order": [[ 1, "asc" ]],
                    "columnDefs": [ {
                        "targets": [0,1,2,3],
                        "render": function (data, type, row, meta) {
                            if ( data && type == 'display' ) {
                                return data.escapeHtml();
                            }
                            return data;
                        }
                    } ],
                    "columns": [
                        {
                            "data": "biblio.title:biblio.subtitle:biblio.medium",
                            "title": _("Título"),
                            "searchable": true,
                            "orderable": true,
                            "render": function(data, type, row, meta) {
                                return $biblio_to_html(row.biblio, { link: 1 });
                            }
                        },
                        {
                            "data": "biblio.author",
                            "title": _("Autor"),
                            "searchable": true,
                            "orderable": true,
                        },
                        {
                            "data": "callnumber",
                            "title": _("Cota"),
                            "searchable": true,
                            "orderable": true,
                        },
                        {
                            "data": "external_id",
                            "title": _("Código de barras"),
                            "searchable": true,
                            "orderable": true,
                        },
                        {
                            "data": "lost_status:last_seen_date:return_claim.patron",
                            "title": _("Estado"),
                            "searchable": false,
                            "orderable": true,
                            "render": function(data, type, row, meta) {
                                if ( row.lost_status == bundle_lost_value ) {
                                    let out = '<span class="lost">' + _("Último acesso") + ': ' + $date(row.last_seen_date) + '</span>';
                                    if ( row.return_claim ) {
                                        out = out + '<span class="claims_return">' + _("Reclamaçãos devolvidas por") + ': ' + $patron_to_html( row.return_claim.patron, { display_cardnumber: false, url: true } ) + '</span>';
                                    }
                                    return out;
                                }
                                else if ( row.lost_status !== 0 ) {
                                    return '<span class="lost">' + _("Perdido") + ': ' + row.lost_status + '</span>';
                                }
                                return '<span class="available">' + _("Presente") + '</span>';
                            }
                        },
                        {
                            "data": function( row, type, val, meta ) {
                                var result;
                                if (duedate) {
                                    result = '<button class="btn btn-default btn-xs remove disabled" role="button" data-itemnumber="'+row.item_id+'" title="%s"><i class="fa fa-minus" aria-hidden="true"></i> %s</button>\n'.format(_("Este conjunto está emprestado, não pode ser modificado"), _("Remover"));
                                } else {
                                    result = '<button class="btn btn-default btn-xs remove" role="button" data-itemnumber="'+row.item_id+'"><i class="fa fa-minus" aria-hidden="true"></i> '+_("Remover")+'</button>\n';
                                }
                                return result;
                            },
                            "title": _("Ações"),
                            "searchable": false,
                            "orderable": false,
                            "class": "noExport"
                        }
                    ]
                }, bundle_settings, 1);
                $(".tbundle").on("click", ".remove:not(.disabled)", function(){
                    var bundle_table = $(this).closest('table');
                    var host_itemnumber = bundle_table.data('itemnumber');
                    var component_itemnumber = $(this).data('itemnumber');
                    var unlink_item_url = "/api/v1/items/" + host_itemnumber + "/bundled_items/" + component_itemnumber;
                    $.ajax({
                        type: "DELETE",
                        url: unlink_item_url,
                        success: function(){
                            bundle_table.DataTable({ 'retrieve': true }).draw(false);
                        }
                    });
                });

                return;
            }

            var bundle_changed;
            var bundle_form_active;
            $("#addToBundleModal").on("shown.bs.modal", function(e){
                var button = $(e.relatedTarget);
                var item_id = button.data('item');
                $("#addResult").replaceWith('<div id="addResult"></div>');
                $("#addToBundleForm").attr('action', '/api/v1/items/' + item_id + '/bundled_items');
                $("#external_id").focus();
                bundle_changed = 0;
                bundle_form_active = item_id;
            });

            function addToBundle (url, data) {
                  /* Send the data using post with external_id */
                  var posting = $.post({
                      url: url,
                      data: JSON.stringify(data),
                      contentType: "application/json; charset=utf-8",
                      dataType: "json"
                  });

                  const barcode = data.external_id;

                  /* Report the results */
                  posting.done(function(data) {
                      $('#addResult').replaceWith('<div id="addResult" class="alert alert-success">'+_("Sucesso: Adicionou '%s'").format(barcode)+'</div>');
                      $('#external_id').val('').focus();
                      bundle_changed = 1;
                  });
                  posting.fail(function(data) {
                      if ( data.status === 409 ) {
                          var response = data.responseJSON;
                          if ( response.error_code === 'already_bundled' ) {
                              $('#addResult').replaceWith('<div id="addResult" class="alert alert-warning">'+_("Aviso: Exemplar '%s' já associado").format(barcode)+'</div>');
                          } else if (response.error_code === 'bundle_checkout_out') {
                              $('#addResult').replaceWith('<div id="addResult" class="alert alert-danger">'+_("Erro: Conjunto já emprestado")+'</div>');
                          } else if (response.error_code === 'checked_out') {
                              const button = $('<button type="button">')
                                .addClass('btn btn-xs')
                                .text(_("Devolver e adicionar ao conjunto"))
                                .on('click', function () {
                                    addToBundle(url, { external_id: barcode, force_checkin: true });
                                });
                              $('#addResult')
                                .empty()
                                .attr('class', 'alert alert-warning')
                                .append(__x('Warning: Item {barcode} is checked out', { barcode }))
                                .append(' ', button);
                          } else if (response.error_code === 'failed_checkin') {
                              $('#addResult')
                                .empty()
                                .attr('class', 'alert alert-danger')
                                .append(__x('Failure: Item {barcode} cannot be checked in', { barcode }))
                          } else if (response.error_code === 'reserved') {
                              const button = $('<button type="button">')
                                .addClass('btn btn-xs')
                                .text(_("Ignorar reservas e adicionar ao conjunto"))
                                .on('click', function () {
                                    addToBundle(url, { external_id: barcode, ignore_holds: true });
                                });
                              $('#addResult')
                                .empty()
                                .attr('class', 'alert alert-warning')
                                .append(__x('Warning: Item {barcode} is on hold', { barcode }))
                                .append(' ', button);
                          } else {
                              $('#addResult').replaceWith('<div id="addResult" class="alert alert-danger">'+_("Falha: O exemplar '%s' pertence a outro conjunto").format(barcode)+'</div>');
                          }
                      } else if ( data.status === 404 ) {
                          $('#addResult').replaceWith('<div id="addResult" class="alert alert-danger">'+_("Falha: O exemplar '%s' não foi encontrado").format(barcode)+'</div>');
                      } else if ( data.status === 400 ) {
                          var response = data.responseJSON;
                          if ( response.error_code === "failed_nesting" ) {
                              $('#addResult').replaceWith('<div id="addResult" class="alert alert-danger">'+_("Falha: O exemplar '%s' é um conjunto e os conjuntos não podem ser aninhados").format(barcode)+'</div>');
                          } else {
                              $('#addResult').replaceWith('<div id="addResult" class="alert alert-danger">'+_("Falha: Verifique o log para mais detalhes")+'</div>');
                          }
                      } else {
                          $('#addResult').replaceWith('<div id="addResult" class="alert alert-danger">'+_("Falha: Verifique o log para mais detalhes")+'</div>');
                      }
                      $('#external_id').val('').focus();
                  });
            }

            $("#addToBundleForm").submit(function(event) {
                  /* stop form from submitting normally */
                  event.preventDefault();

                  const url = this.action;
                  const data = { external_id: this.elements.external_id.value };

                  addToBundle(url, data);
            });

            $("#addToBundleModal").on("hidden.bs.modal", function(e){
                if ( bundle_changed ) {
                    $('#bundle_table_'+bundle_form_active).DataTable({ 'retrieve': true }).ajax.reload();
                }
                bundle_form_active = 0;
                bundle_changed = 0;
            });

            $("#removeFromBundleModal").on("shown.bs.modal", function(e){
                var button = $(e.relatedTarget);
                var item_id = button.data('item');
                $("#removeResult").replaceWith('<div id="removeResult"></div>');
                $("#removeFromBundleForm").attr('action', '/api/v1/items/' + item_id + '/bundled_items/');
                $("#rm_external_id").focus();
                bundle_changed = 0;
                bundle_form_active = item_id;
            });

            $("#removeFromBundleForm").submit(function(event) {

                /* stop form from submitting normally */
                event.preventDefault();

                /* get the action attribute from the <form action=""> element */
                var $form = $(this),
                url = $form.attr('action');

                var barcode = $('#rm_external_id').val();

                /* Fetch itemnumber using rm_external_id */
                var itemReq = $.get('/api/v1/items', { q: JSON.stringify({
                    external_id: barcode
                }) }, null, "json");

                var itemnumber;
                itemReq.done(function(data) {
                    if (data.length === 1) {
                        itemnumber = data[0].item_id;

                        /* Remove link using fetch itemnumber */
                        var deleteReq = $.ajax( url + itemnumber, {
                            type : 'DELETE'
                        });

                        /* Report the results */
                        deleteReq.done(function(data) {
                            var barcode = $('#rm_external_id').val();
                            $('#removeResult').replaceWith('<div id="removeResult" class="alert alert-success">'+_("Sucesso: Removeu '%s'").format(barcode)+'</div>');
                            $('#rm_external_id').val('').focus();
                            bundle_changed = 1;
                        });
                        deleteReq.fail(function(data) {
                            var barcode = $('#rm_external_id').val();
                            if ( data.status === 409 ) {
                                var response = data.responseJSON;
                                if (response.error_code === 'bundle_checkout_out') {
                                    $('#removeResult').replaceWith('<div id="removeResult" class="alert alert-danger">'+_("Erro: Conjunto já emprestado")+'</div>');
                                } else if ( response.key === "PRIMARY" ) {
                                    $('#removeResult').replaceWith('<div id="removeResult" class="alert alert-warning">'+_("Aviso: Exemplar '%s' já associado").format(barcode)+'</div>');
                                } else {
                                    $('#removeResult').replaceWith('<div id="removeResult" class="alert alert-danger">'+_("Falha: O exemplar '%s' pertence a outro conjunto").format(barcode)+'</div>');
                                }
                            } else if ( data.status === 404 ) {
                                $('#addResult').replaceWith('<div id="addResult" class="alert alert-danger">'+_("Falha: O exemplar '%s' não foi encontrado").format(barcode)+'</div>');
                            } else {
                                $('#removeResult').replaceWith('<div id="removeResult" class="alert alert-danger">'+_("Falha: Verifique o log para mais detalhes")+'</div>');
                            }
                            $('#rm_external_id').val('').focus();
                        });
                    } else {
                        $('#removeResult').replaceWith('<div id="removeResult" class="alert alert-danger">'+_("Falha: o código de barras foi encontrado em mais que um exemplar '%s'").format(barcode)+'</div>');
                    }
                });
                itemReq.fail(function(data) {
                     $('#removeResult').replaceWith('<div id="removeResult" class="alert alert-danger">'+_("Falha: Exemplar não encontrado '%s'").format(barcode)+'</div>');
                    $('#rm_external_id').val('').focus();

                });
            });

            $("#removeFromBundleModal").on("hidden.bs.modal", function(e){
                if ( bundle_changed ) {
                    $('#bundle_table_'+bundle_form_active).DataTable({ 'retrieve': true }).ajax.reload();
                }
                bundle_form_active = 0;
                bundle_changed = 0;
            });
            // End bundle handling
            [% END %]

            var table_names = [ 'holdings_table', 'otherholdings_table' ];
            var table_settings = [ [% TablesSettings.GetTableSettings('catalogue', 'detail','holdings_table','json') | $raw %], [% TablesSettings.GetTableSettings('catalogue', 'detail','otherholdings_table','json')  | $raw %] ];
            var has_images = [ "[% itemloop_has_images | html %]", "[% otheritemloop_has_images | html %]" ];
            table_names.forEach( function( table_name, index ) {
                if ( !has_images[index] ) {
                    table_settings[index].columns.splice(1,1);
                }
                var dt_parameters = {
                    'sDom': 't',
                    'bPaginate': false,
                    'bAutoWidth': false,
                    "bKohaColumnsUseNames": true,
                    "sDom": 'C<"top pager"ilpfB><"#filter_c">tr<"bottom pager"ip>',
                };
                var table = KohaTable( table_name, dt_parameters, table_settings[index], 'with_filters' );

                [% IF bundlesEnabled %]
                // Add event listener for opening and closing bundle details
                $('#' + table_name + ' tbody').on('click', 'button.details-control', function () {
                    var button = $(this);
                    var tr = button.closest('tr');
                    var dTable = button.closest('table').DataTable({ 'retrieve': true });

                    var itemnumber = tr.data('itemnumber');
                    var duedate = tr.data('duedate');
                    var row = dTable.row( tr );

                    if ( row.child.isShown() ) {
                        // This row is already open - close it
                        row.child.hide();
                        tr.removeClass('shown');
                        button.removeClass('active');
                    }
                    else {
                        // Open this row
                        createChild(row, itemnumber, duedate);
                        tr.addClass('shown');
                        button.addClass('active');
                    }
                } );
                [% END %]
            });

            [% IF Koha.Preference('AcquisitionDetails') %]
                var table_settings = [% TablesSettings.GetTableSettings('catalogue', 'detail', 'acquisitiondetails-table', 'json') | $raw %];
                var acquisitiondetails_table = KohaTable("orders", {
                    "sDom": 'C<"top pager"ilpfB><"#filter_c">tr<"bottom pager"ip>',
                    'bPaginate': false,
                    'bAutoWidth': false,
                    "aaSorting": [[ 4, "desc" ]],
                }, table_settings);
            [% END %]

            [% IF suggestions.count %]
                $(".sorted").dataTable($.extend(true, {}, dataTablesDefaults, {
                    "aoColumnDefs": [
                        { "bSortable": false, "bSearchable": false, 'aTargets': [ 'NoSort' ] },
                        { "sType": "anti-the", "aTargets" : [ "anti-the" ] }
                    ],
                    "sPaginationType": "full"
                }));
            [% END %]

        });

        function columnsInit(table) {
            activate_filters(table.id, false);
        }

        [% IF found1 && Koha.Preference('RetainCatalogSearchTerms') %]
            $(document).ready(function() {
                var search_index = localStorage.getItem("cat_search_pulldown_selection");
                var search_value = localStorage.getItem("searchbox_value");
                if ( search_index ){ $('#cat-search-block select.advsearch').val(search_index)};
                if ( search_value ){ $('#cat-search-block #search-form').val(search_value)};
            });
        [% END %]

        [% IF Koha.Preference('EnableItemGroups') %]
            // Load item groups table
            var itemGroupsTable = KohaTable("items-group-table", {
                "bAutoWidth": false,
                'sDom': '<"top pager"ilp>t<"bottom pager"ip>r',
                "aoColumns": [
                    {
                        "mDataProp": function( oObj ) {
                            return oObj.display_order;
                        },
                    },
                    {
                        "mDataProp": function( oObj ) {
                            return oObj.description;
                        },
                    },
                    {
                        "mDataProp": function( oObj ) {
                            [% IF CAN_user_editcatalogue_manage_item_groups %]
                                return `<button class='item-group-edit btn btn-default btn-xs' data-item-group-id='${oObj.item_group_id}'>
                                    <i class='fa fa-edit'></i> ${_("Alterar")}
                                </button>`
                                + '&nbsp'
                                + `<button class='item-group-delete btn btn-default btn-xs' data-item-group-id='${oObj.item_group_id}'>
                                    <i class='fa fa-trash'></i> ${('Delete')}
                                </button>`;
                            [% ELSE %]
                                return "";
                            [% END %]
                        },
                    },
                ],
                "bPaginate": false,
                "bProcessing": true,
                "bServerSide": false,
                "sAjaxSource": `/api/v1/biblios/${biblionumber}/item_groups?_per_page=-1`,
                "sAjaxDataProp": "",
                "fnServerData": function ( sSource, aoData, fnCallback ) {
                    $.getJSON( sSource, aoData, function (json) {
                        fnCallback(json)
                    } );
                },
            });

            // Create new item groups
            $('.item-group-create').on('click', function(){
                $('#modal-item-group-create-form-description').val("");
                $('#modal-item-group-create-submit').removeAttr('disabled');
                $('#modal-item-group-create').modal('show');
            });

            $("#modal-item-group-create-form").validate({
                submitHandler: function(form) {
                    $.ajax({
                        url: `/api/v1/biblios/${biblionumber}/item_groups`,
                        headers: { "x-koha-embed": "items" },
                        success: function(item_groups){
                            $('#modal-item-group-create-submit').attr('disabled', 'disabled');

                            var settings = {
                              "url": `/api/v1/biblios/${biblionumber}/item_groups`,
                              "method": "POST",
                              "headers": {
                                "Content-Type": "application/json"
                              },
                              "data": JSON.stringify(
                                  {
                                      "description": $("#modal-item-group-create-form-description").val(),
                                      "display_order": $("#modal-item-group-create-form-display_order").val(),
                                  }
                              ),
                            };

                            $.ajax(settings)
                            .done(function (response) {
                                $('#item-group-add-form-select').append($('<option>', {
                                    value: response.item_group_id,
                                    text: response.description
                                }));

                                $('#modal-item-group-create').modal('hide');
                                if ( item_groups.length == 0 ) {
                                    // This bib has no previous item groups, reload the page
                                    window.location.replace(`/cgi-bin/koha/catalogue/detail.pl?biblionumber=${biblionumber}`);
                                } else {
                                    // Has other item groups, just reload the table
                                    itemGroupsTable.api().ajax.reload();
                                }
                            })
                            .fail(function(err) {
                                var message = err.responseJSON.error;
                                alert(message);
                            });
                        }
                    });
                }
            });

            $('#modal-item-group-create').on('shown.bs.modal', function () {
                $('#modal-item-group-create-form-description').focus();
            })

            // Edit existing item groups
            $('body').on( 'click', '.item-group-edit', function(){
                const item_group_id = $(this).data('item-group-id');
                const url = `/api/v1/biblios/${biblionumber}/item_groups/${item_group_id}`;
                $.get( url, function( data ) {
                    $('#modal-item-group-edit-form-description').val( data.description );
                    $('#modal-item-group-edit-form-display_order').val( data.display_order );
                    $('#modal-item-group-edit-submit').data('item-group-id', item_group_id );
                    $('#modal-item-group-edit-submit').removeAttr('disabled');
                    $('#modal-item-group-edit').modal('show');
                });
            });

            $("#modal-item-group-edit-form").validate({
                submitHandler: function(form) {
                    $('#modal-item-group-edit-submit').attr('disabled', 'disabled');

                    const item_group_id = $('#modal-item-group-edit-submit').data('item-group-id');
                    const url = `/api/v1/biblios/${biblionumber}/item_groups/${item_group_id}`;

                    var settings = {
                      "url": url,
                      "method": "PUT",
                      "headers": {
                        "Content-Type": "application/json"
                      },
                      "data": JSON.stringify(
                          {
                              "description": $("#modal-item-group-edit-form-description").val(),
                              "display_order": $("#modal-item-group-edit-form-display_order").val(),
                          }
                      ),
                    };

                    $.ajax(settings)
                    .done(function (response) {
                        $('#modal-item-group-edit').modal('hide');
                        itemGroupsTable.api().ajax.reload();
                    })
                    .fail(function(err) {
                        var message = err.responseJSON.error;
                        alert(message);
                    });
                }
            });

            $('#modal-item-group-edit').on('shown.bs.modal', function () {
                $('#modal-item-group-edit-form-description').focus();
            })

            // Delete existing item groups
            $('body').on( 'click', '.item-group-delete', function(){
                const item_group_id = $(this).data('item-group-id');
                $('#modal-item-group-delete-submit').data('item-group-id', item_group_id );
                $('#modal-item-group-delete-submit').removeAttr('disabled');
                $('#modal-item-group-delete').modal('show');
            });
            $("#modal-item-group-delete-submit").on('click', function(){
                $('#modal-item-group-delete-submit').attr('disabled', 'disabled');
                const item_group_id = $("#modal-item-group-delete-submit").data('item-group-id');

                $.ajax({
                    url: `/api/v1/biblios/${biblionumber}/item_groups/${item_group_id}`,
                    headers: { "x-koha-embed": "items" },
                    success: function(item_group_data){
                        $.ajax({
                          "url": `/api/v1/biblios/${biblionumber}/item_groups/${item_group_id}`,
                          "method": "DELETE",
                        })
                        .done(function (response) {
                            $('#modal-item-group-delete').modal('hide');
                            $(`#item-group-add-form-select option[value='${item_group_id}']`).remove();
                            if ( item_group_data.items === null ) {
                                // No items for this item group, we can just refresh the table
                                itemGroupsTable.api().ajax.reload();
                            } else {
                                // This item group had items attached to it, we need to reload the page
                                window.location.replace(`/cgi-bin/koha/catalogue/detail.pl?biblionumber=${biblionumber}`);
                            }
                        })
                        .fail(function(err) {
                            var message = err.responseJSON.error;
                            alert(message);
                        });
                    }
                });
            });

            // Add item(s) to a item group
            $('.itemselection_action_item_group_set').on('click', function(){
                $('#modal-item-group-set').modal('show');
            });

            $("#modal-item-group-set-form").validate({
                submitHandler: function(form) {
                    $('#modal-item-group-set-submit').attr('disabled', 'disabled');

                    const item_group_id = $('#item-group-add-form-select').val();

                    let itemnumbers = new Array();
                    $("input[name='itemnumber'][type='checkbox']:checked").each(function() {
                        const itemnumber = $(this).val();
                        itemnumbers.push( itemnumber );
                    });
                    if (itemnumbers.length > 0) {
                        let url = '/cgi-bin/koha/catalogue/detail.pl?op=set_item_group';
                        url += '&itemnumber=' + itemnumbers.join('&itemnumber=');
                        url += '&biblionumber=[% biblionumber | uri %]';
                        url += `&item_group_id=${item_group_id}`;

                        window.location.replace(url);
                    }

                    $('#modal-item-group-set').modal('hide');
                }
            });

            // Remove item(s) from an item group
            $('.itemselection_action_item_group_unset').on('click', function(){
                $('#modal-item-group-unset').modal('show');
            });

            $("#modal-item-group-unset-submit").on('click', function(){
                $('#modal-item-group-unset-submit').attr('disabled', 'disabled');

                let itemnumbers = new Array();
                $("input[name='itemnumber'][type='checkbox']:checked").each(function() {
                    const itemnumber = $(this).val();
                    itemnumbers.push( itemnumber );
                });
                if (itemnumbers.length > 0) {
                    let url = '/cgi-bin/koha/catalogue/detail.pl?op=unset_item_group';
                    url += '&itemnumber=' + itemnumbers.join('&itemnumber=');
                    url += '&biblionumber=[% biblionumber | uri %]';

                    window.location.replace(url);
                }

                $('#modal-item-group-unset').modal('hide');

            });
        [% END %]
    </script>
 [% CoverImagePlugins | $raw %]
[% END %]
[% INCLUDE 'intranet-bottom.inc' %]
